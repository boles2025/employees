<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الملاحظات والامتحانات تصميم مهندس بولس سمير</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css">

    <style>
        :root {
            /*
             * تم تحديث لوحة الألوان لتكون أكثر حيوية وتنوعاً.
             * الألوان الجديدة تعطي مظهرًا جذابًا ومتغيرًا عبر العناصر المختلفة
             * كما تعمل مع التقارير والشاشات والطباعة.
             */
            /* تم تغيير لوحة الألوان لتكون أكثر حداثة وملائمة للعرض على الجوال والكمبيوتر */
            --primary: #4caf50;       /* أخضر عصري */
            --primary-light: #81c784; /* أخضر فاتح */
            --secondary: #0288d1;     /* أزرق سماوي */
            --secondary-dark: #0277bd;/* أزرق غامق */
            --accent: #ff5722;        /* برتقالي زاهي */
            --accent-light: #ffb74d;  /* برتقالي فاتح */
            --bg: #f3f7f9;            /* رمادي فاتح */
            --bg-gradient: linear-gradient(135deg, #ffffff 0%, #f3f7f9 100%);
            --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.07);
            --hover-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
            --transition: all 0.4s ease;
        }
        
        * {
            transition: var(--transition);
        }

        /* إعادة تخطيط لوحة التحكم إلى الوضع العمودي وإلغاء تحويلها إلى شريط علوي */
        #adminDashboardView .container-fluid > .row {
            /* اجعل اتجاه العناصر انعكاسياً ليتناسب مع وضعية العرض من اليمين إلى اليسار، بحيث يظهر الشريط الجانبي على اليمين ومحتوى لوحة الإدارة على اليسار */
            flex-direction: row-reverse !important;
        }
        #adminDashboardView #adminSidebar {
            width: auto !important;
            max-width: 240px !important;
            height: 100vh !important;
            /* تجنب فرض display:block هنا حتى لا يلغى تأثير فئة d-none عند الإخفاء */
            flex-direction: column !important;
        }
        #adminDashboardView #adminSidebar nav {
            flex-direction: column !important;
            flex-wrap: nowrap !important;
            width: 100%;
        }
        #adminDashboardView #adminSidebar nav a {
            display: block !important;
            width: 100%;
        }

        /* تم إزالة تحويل الشريط الجانبي إلى شريط أفقي. سيظل الشريط الجانبي عمودياً ويمكن إخفاؤه أو إظهاره عبر الزر المخصص. */
        /* إخفاء رأس المعلومات في الشريط العلوي */
        #adminDashboardView .admin-sidebar .text-center.mb-4 {
            display: none;
        }
        /* إخفاء رقم النسخة في الشريط العلوي */
        #adminDashboardView .admin-sidebar .position-absolute.bottom-0 {
            display: none;
        }
        /* ضبط محتوى لوحة الإدارة ليملأ الشاشة تحت الشريط الجديد */
        #adminDashboardView .col-md-10.p-4 {
            width: 100% !important;
            max-width: 100% !important;
            /* إزالة المساحة العلوية الزائدة للاقتراب من الشريط العلوي */
            margin-top: 0 !important;
            padding-top: 0 !important;
        }
        /* إعدادات الطباعة لعرض تذييل الملاحظات اليومية */
        @media print {
            #dailyNotesFooter {
                display: block !important;
            }
        }

        /* عند الطباعة لا يتم إجبار عرض تبويب معين بل يتم طباعة المحتوى الظاهر حالياً. */
        /* تمت إزالة القواعد التي كانت تحصر الطباعة في تبويب الملاحظات اليومية (#adm6) لإتاحة طباعة الجدول العام وبقية التبويبات. */

        /* ضبط مظهر حاوية التحكم في اللون داخل شريط الإدارة */
        #adminDashboardView .admin-sidebar > .p-3 {
            display: flex;
            align-items: center;
            flex-wrap: nowrap;
            gap: 8px;
            /* ترتيب التسمية واختيار اللون بشكل أفقي */
            flex-direction: row;
            margin: 0;
            padding: 0;
        }
        #adminDashboardView .admin-sidebar > .p-3 label {
            margin: 0 !important;
            font-size: 0.75rem;
            color: #fff;
        }

        #adminDashboardView .admin-sidebar > .p-3 #colorPicker {
            flex: 0 0 auto !important;
        }
        #adminDashboardView #colorPicker {
            width: 36px !important;
            height: 36px !important;
            padding: 0;
            border: 2px solid #ffffff;
            border-radius: 50%;
            cursor: pointer;
        }
        
        body {
            font-family: 'Tajawal', sans-serif;
            background: var(--bg-gradient);
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .navbar {
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 15px 0;
            backdrop-filter: blur(10px);
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            letter-spacing: -0.5px;
        }
        
        .main-card {
            border: none;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            background: white;
            padding: 30px;
            margin-top: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .main-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--secondary) 0%, var(--accent) 100%);
        }
        
        .main-card:hover {
            box-shadow: var(--hover-shadow);
            transform: translateY(-5px);
        }
        
        .swapped-row {
            background: linear-gradient(90deg, #fff9e6 0%, #fff3cd 100%) !important;
            border-right: 5px solid var(--accent-light);
            position: relative;
        }
        
        /*
         * قمنا بإزالة العنصر الوهمي (::before) من الصفوف التى تم تبادلها لأن وجوده
         * كان يسبب تحريك الأعمدة ناحية اليمين مما يجعل المعلومات تظهر تحت أعمدة
         * غير صحيحة عند عرض الجدول للمستخدم. بدلاً من إضافة أيقونة عبر pseudo-element
         * يمكن تمييز الصفوف الملونة من خلال الخلفية والحدود فقط.
         */
        .swapped-row::before {
            display: none;
        }
        
        #adminDashboardView {
            background-color: #f1f5f9;
            min-height: 100vh;
            display: none;
        }
        
        .admin-sidebar {
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            min-height: 100vh;
            padding-top: 20px;
            box-shadow: 5px 0 20px rgba(0, 0, 0, 0.1);
        }
        
        .admin-nav-link {
            color: rgba(255, 255, 255, 0.85);
            padding: 14px 20px;
            display: block;
            text-decoration: none;
            border-radius: 10px;
            margin: 5px 10px;
            position: relative;
            overflow: hidden;
        }
        
        .admin-nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            right: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.2) 100%);
            transition: var(--transition);
        }
        
        .admin-nav-link:hover::before,
        .admin-nav-link.active::before {
            right: 0;
        }
        
        .admin-nav-link:hover,
        .admin-nav-link.active {
            background: rgba(255, 255, 255, 0.3) !important;
            color: #fff !important;
            transform: translateY(-2px);
        }
        
        .request-card {
            border-left: 6px solid #ddd;
            transition: var(--transition);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            /* تصغير حجم الخط داخل بطاقات الطلبات لتبدو أكثر أناقة */
            font-size: 0.9rem;
        }
        
        .request-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.8) 100%);
            transform: translateX(100%);
            transition: transform 0.5s ease;
        }
        
        .request-card:hover::after {
            transform: translateX(0);
        }
        
        .request-card:hover {
            transform: translateY(-7px) scale(1.01);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        /* تخصيص شكل التوست (الإشعارات العائمة) ليكون بيضاوي وصغير مع ألوان جذابة */
        .custom-toast {
            /*
             * تضبيط شكل التوستات العائمة لتكون صغيرة وبيضاوية مع ألوان جذابة.
             * زيادة نصف القطر يجعل الزوايا أكثر نعومة بينما يقلل حجم الخط والمسافات
             * بحيث تبدو التوستات كأشرطة تنبيهية رشيقة. يتم ضبط المحاذاة بحيث يظهر
             * الأيقونة والنص بشكل متناسق.
             */
            border-radius: 30px;
            padding: 0.4rem 0.8rem;
            font-size: 0.80rem;
            display: flex;
            align-items: center;
            box-shadow: var(--hover-shadow);
        }
        /* إضافة حدود ملونة حسب نوع الإشعار */
        .custom-toast.swal2-success {
            border-left: 5px solid var(--primary);
        }
        .custom-toast.swal2-error {
            border-left: 5px solid var(--accent);
        }
        .custom-toast.swal2-info {
            border-left: 5px solid var(--secondary);
        }
        .custom-toast .swal2-title {
            margin: 0;
            flex: 1;
        }
        .custom-toast .swal2-icon {
            margin-left: 0.5rem;
            margin-right: 0.5rem;
        }
        
        .status-pending {
            border-left-color: var(--accent-light);
        }
        
        .status-approved {
            border-left-color: var(--secondary);
        }
        
        .btn-primary {
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
            border: none;
            border-radius: 10px;
            padding: 10px 25px;
            font-weight: 600;
        }
        
        .btn-primary:hover {
            background: linear-gradient(90deg, var(--primary-light) 0%, var(--primary) 100%);
            transform: translateY(-2px);
            box-shadow: 0 7px 15px rgba(44, 62, 80, 0.2);
        }
        
        .btn-success {
            background: linear-gradient(90deg, var(--secondary) 0%, var(--secondary-dark) 100%);
            border: none;
            border-radius: 10px;
            padding: 10px 25px;
            font-weight: 600;
        }
        
        .btn-success:hover {
            background: linear-gradient(90deg, var(--secondary-dark) 0%, var(--secondary) 100%);
            transform: translateY(-2px);
            box-shadow: 0 7px 15px rgba(26, 188, 156, 0.2);
        }
        
        .btn-warning {
            background: linear-gradient(90deg, var(--accent) 0%, var(--accent-light) 100%);
            border: none;
            border-radius: 10px;
            padding: 10px 25px;
            font-weight: 600;
            color: white;
        }
        
        .btn-warning:hover {
            background: linear-gradient(90deg, var(--accent-light) 0%, var(--accent) 100%);
            transform: translateY(-2px);
            box-shadow: 0 7px 15px rgba(230, 126, 34, 0.2);
        }
        
        .form-control {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
            font-size: 1rem;
        }
        
        .form-control:focus {
            border-color: var(--secondary);
            box-shadow: 0 0 0 0.25rem rgba(26, 188, 156, 0.25);
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in-up {
            animation: fadeInUp 0.6s ease forwards;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        #loadingOverlay {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .loader {
            width: 70px;
            height: 70px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background: linear-gradient(90deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .table {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .table thead th {
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            padding: 15px;
            font-weight: 600;
        }
        
        .table tbody tr {
            border-bottom: 1px solid #f1f1f1;
        }

        /* إضافة تباين بالألوان بين الصفوف لزيادة الجاذبية */
        .table tbody tr:nth-child(odd) {
            background-color: rgba(243, 156, 18, 0.05); /* لون برتقالي فاتح */
        }
        .table tbody tr:nth-child(even) {
            background-color: rgba(142, 68, 173, 0.05); /* لون أرجواني فاتح */
        }

        .table tbody tr:hover {
            background-color: rgba(231, 76, 60, 0.1); /* لون أحمر فاتح عند المرور */
        }
        
        .designer-footer {
            margin-top: 30px;
            padding-top: 15px;
            border-top: 2px solid #eee;
            text-align: center;
            font-weight: bold;
            /* استخدم الأرجواني كونه لوناً ثانوياً لجذب الانتباه */
            color: var(--secondary);
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* شريط شكر متحرك لجذب الانتباه */
        .thank-you-banner {
            width: 100%;
            overflow: hidden;
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
            color: #fff;
            padding: 8px 0;
            position: fixed;
            bottom: 0;
            left: 0;
            z-index: 1050;
            font-weight: bold;
            text-align: center;
        }

        .thank-you-banner span {
            display: inline-block;
            padding-left: 100%;
            white-space: nowrap;
            animation: marquee 15s linear infinite;
        }

        @keyframes marquee {
            0%   { transform: translateX(0%); }
            100% { transform: translateX(-100%); }
        }

        /* تعديل الشريط أثناء الطباعة ليظهر في أسفل التقارير بشكل ثابت */
        @media print {
            .thank-you-banner {
                position: static;
                background: transparent;
                color: var(--secondary);
                padding: 8px 0;
            }
            .thank-you-banner span {
                animation: none;
                padding-left: 0;
            }
        }
        
        /* تحسين الطباعة */
        @media print {
            body * {
                visibility: hidden;
            }
            
            #adminDashboardView, #adminDashboardView * {
                visibility: visible;
            }
            
            .no-print, .no-print * {
                display: none !important;
            }
            
            .admin-sidebar {
                display: none !important;
            }

            /* عرض ترويسة الملاحظات اليومية أثناء الطباعة وإخفاء صف التحكم الخاص بالتاريخ */
            #dailyNotesHeader {
                display: flex !important;
            }
            .daily-notes-control-row {
                display: none !important;
            }
            
            .col-md-10 {
                width: 100% !important;
                margin-right: 0 !important;
                margin-left: 0 !important;
                padding: 0 !important;
            }
            
            .main-card {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
                padding: 15px !important;
                margin: 0 !important;
                width: 100% !important;
            }
            
            #masterReportArea table {
                font-size: 10px !important;
                width: 100% !important;
            }
            
            #masterReportArea th,
            #masterReportArea td {
                padding: 4px 6px !important;
                font-size: 9px !important;
            }
            
            @page {
                size: A4 landscape;
                margin: 0.5cm;
            }
            
            body {
                margin: 0;
                padding: 0;
            }
        }
        
        .floating-action-btn {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(90deg, var(--secondary) 0%, var(--secondary-dark) 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 5px 20px rgba(26, 188, 156, 0.4);
            cursor: pointer;
            z-index: 100;
            animation: pulse 2s infinite;
        }
        
        .floating-action-btn:hover {
            transform: scale(1.1) rotate(90deg);
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        
        .stats-card i {
            font-size: 2.5rem;
            margin-bottom: 10px;
            opacity: 0.9;
        }
        
        .stats-card .number {
            font-size: 2rem;
            font-weight: 700;
        }
        
        .stats-card .label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .progress-container {
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary) 0%, var(--accent) 100%);
            border-radius: 5px;
            transition: width 1s ease;
        }
        
        .tab-content {
            padding: 20px;
            background: white;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .nav-tabs {
            border-bottom: 2px solid #dee2e6;
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: var(--primary);
            font-weight: 600;
            padding: 12px 25px;
            border-radius: 10px 10px 0 0;
            margin-left: 5px;
        }
        
        .nav-tabs .nav-link.active {
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
        }
        
        /* تحسينات الجدول العام */
        #masterReportArea table {
            font-size: 12px;
        }
        
        #masterReportArea th {
            font-size: 11px;
            padding: 8px 5px;
            white-space: nowrap;
        }
        
        #masterReportArea td {
            font-size: 11px;
            padding: 6px 4px;
        }
        
        /* تحسينات الجدول في شاشة المستخدم */
        #scheduleTableBody td {
            padding: 12px 8px;
            vertical-align: middle;
            font-size: 14px;
        }
        
        #scheduleTableBody .badge {
            font-size: 12px;
            padding: 5px 8px;
        }
        
        /* تحسينات حفظ الجدول كصورة */
        .schedule-for-capture {
            padding: 20px;
            background: white;
            color: #000 !important;
        }
        
        .schedule-for-capture table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .schedule-for-capture th {
            background: #005f73;
            color: white;
            padding: 10px;
            text-align: center;
        }
        
        .schedule-for-capture td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: center;
            color: #000 !important;
        }
        
        .schedule-for-capture .swapped-row-capture {
            background-color: #fff3cd;
            color: #000 !important;
        }
        
        @media (max-width: 768px) {
            .main-card {
                padding: 20px;
            }
            
            .navbar-brand {
                font-size: 1.2rem;
            }
            
            .floating-action-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
                bottom: 20px;
                left: 20px;
            }
            
            #masterReportArea table {
                font-size: 10px;
            }
        }
        
        /* تحسينات عرض الجدول للمستخدم */
        .schedule-table-container {
            overflow-x: auto;
        }
        
        .schedule-table {
            width: 100%;
            /* تقليل العرض الأدنى ليتوافق الجدول مع الشاشات الصغيرة والهواتف المحمولة */
            min-width: 550px;
        }

        /* تصغير حجم الخلايا والنصوص داخل جدول الموظف لضمان ظهور جميع الأعمدة على الأجهزة الصغيرة */
        .schedule-table th,
        .schedule-table td {
            white-space: nowrap;
            font-size: 13px;
        }
        
        .schedule-table th:nth-child(1),
        .schedule-table td:nth-child(1) {
            width: 100px; /* ترتيب اليوم ليكون أضيق */
        }
        
        .schedule-table th:nth-child(2),
        .schedule-table td:nth-child(2) {
            width: 120px; /* التاريخ يمكن أن يأخذ مساحة أكبر قليلاً */
        }
        
        .schedule-table th:nth-child(3),
        .schedule-table td:nth-child(3) {
            width: 100px;
        }
        
        .schedule-table th:nth-child(4),
        .schedule-table td:nth-child(4) {
            width: 150px;
        }
        
        .schedule-table th:nth-child(5),
        .schedule-table td:nth-child(5) {
            width: 80px;
        }

        /*
         * لجعل الجداول الأخرى (مثل جدول الملاحظات اليومية) متوافقة مع الهواتف
         * نضيف قاعدة عامة لحاوية Bootstrap التي تضيف ميزة التمرير الأفقي. عند وجود أكثر من عمود،
         * سيتم عرض شريط تمرير أفقى وسيتم الحفاظ على الأعمدة كاملة بدون التفاف.
         */
        .table-responsive table {
            /* ضمان وجود عرض أدنى حتى تظهر الأعمدة كاملة */
            min-width: 550px;
            /* منع التفاف النص داخل الخلايا */
            white-space: nowrap;
        }
        @media (max-width: 576px) {
            .table-responsive table {
                /* تصغير حجم الخط قليلاً في الشاشات الصغيرة */
                font-size: 0.8rem;
            }
        }

        /* إضافة قواعد خاصة بالشاشات الصغيرة (الموبايل) لتصغير حجم الخط والمسافة وعرض الأعمدة */
        @media (max-width: 576px) {
            .schedule-table {
                min-width: 100%;
            }
            .schedule-table th,
            .schedule-table td {
                font-size: 0.75rem;
                padding: 0.25rem 0.3rem;
            }
            /* تقليل عرض الأعمدة في الموبايل */
            .schedule-table th:nth-child(1),
            .schedule-table td:nth-child(1) {
                width: 80px;
            }
            .schedule-table th:nth-child(2),
            .schedule-table td:nth-child(2) {
                width: 100px;
            }
            .schedule-table th:nth-child(3),
            .schedule-table td:nth-child(3) {
                width: 90px;
            }
            .schedule-table th:nth-child(4),
            .schedule-table td:nth-child(4) {
                width: 120px;
            }
            .schedule-table th:nth-child(5),
            .schedule-table td:nth-child(5) {
                width: 60px;
            }
        }
        /* إعادة ضبط تخطيط لوحة الإدارة للوضع العمودي للشريط الجانبي */
        /* هذه القواعد توضع في نهاية ملف النمط لضمان أولوية أعلى على القواعد السابقة */
        #adminDashboardView .container-fluid > .row {
            flex-direction: row !important;
        }
        #adminDashboardView #adminSidebar {
            /* احتفظ بارتفاع الشريط الجانبي واتجاهه ولكن لا تفرض العرض أو الظهور حتى يمكن إخفاؤه وإظهاره عبر الفئات */
            height: 100vh !important;
            flex-direction: column !important;
        }
        #adminDashboardView #adminSidebar nav {
            flex-direction: column !important;
            flex-wrap: nowrap !important;
        }
        #adminDashboardView #adminMain {
            /* عرض القسم الرئيسي يدار بواسطة فئات الشبكة (col-md-*)، لذلك لا نفرض قيماً هنا */
        }

        /* ===== القائمة العلوية الأفقية للوحة التحكم ===== */
        .admin-top-menu {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10400;
            height: 60px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            background-color: var(--main-color, #4caf50);
            color: #fff;
            padding: 0 10px;
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
        }
        .admin-top-menu a {
            flex: 1;
            text-align: center;
            color: inherit;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }
        .admin-top-menu a .icon {
            font-size: 1.2rem;
            margin-bottom: 2px;
        }
        .admin-top-menu a:hover {
            background: rgba(255,255,255,0.15);
            border-radius: 4px;
            padding: 5px;
        }

        /* زر إظهار/إخفاء القائمة الأفقية */
        #adminSidebarToggle {
            background-color: var(--main-color, #4caf50) !important;
            color: #fff !important;
            border: none !important;
        }

    </style>
</head>
<body>

    <div id="loadingOverlay" class="animate__animated animate__fadeIn">
        <div class="loader"></div>
        <p class="mt-3 text-white fw-bold fs-5 animate__animated animate__pulse animate__infinite">جاري تحميل النظام...</p>
    </div>

    <div id="userInterface" style="display: none;">
        <nav class="navbar navbar-dark sticky-top animate__animated animate__fadeInDown">
            <div class="container d-flex justify-content-between align-items-center">
                <!-- شعار الكلية يظهر في الجانب الأيسر مع التسمية تحته -->
                <a class="navbar-brand d-flex flex-column align-items-start">
                    <img src="https://tse2.mm.bing.net/th/id/OIP.yBtj4Qi_E9aiWlLY8KLDGwAAAA?rs=1&amp;pid=ImgDetMain" alt="شعار الكلية" style="height:40px;" class="mb-1">
                    <span class="fw-bold" style="font-size:0.9rem;">كلية الطب البيطري جامعة المنيا</span>
                </a>
                <div class="d-flex align-items-center no-print">
                    <div class="position-relative me-3" style="cursor:pointer" onclick="showNotifications()">
                        <i class="fas fa-bell text-white fa-lg"></i>
                        <span id="notifBadge" class="notification-badge" style="display:none">0</span>
                    </div>
                    <button class="btn btn-outline-light btn-sm ms-3" style="font-weight:600;" onclick="showAdminLogin()">دخول الإدارة</button>
                </div>
            </div>
        </nav>

        <div class="container py-4">
            <div id="searchSection" class="main-card text-center animate__animated animate__fadeInUp">
                <h3 class="mb-4 text-primary fw-bold">مرحباً بك في نظام ادارة الملاحظات والمرقبات</h3>
                <p class="text-muted mb-4">أدخل الرقم القومي للاطلاع على جدول الملاحظات</p>
                <div class="input-group mb-3 mx-auto shadow-sm" style="max-width: 500px;">
                    <input type="text" id="nidInput" class="form-control" placeholder="أدخل الرقم القومي">
                    <button class="btn btn-primary px-4" onclick="searchEmployee()"><i class="fas fa-search me-2"></i>بحث</button>
                </div>
                <div class="mt-3">
                    <!-- تم تغيير نص الزر ليصبح "تعليمات هامة" بدلاً من "كيفية استخدام النظام" -->
                    <button class="btn btn-outline-primary btn-sm" onclick="showHelp()"><i class="fas fa-question-circle me-1"></i>تعليمات هامة</button>
                </div>

                <!-- تعليمات للمستخدم تُعرض في الصفحة الرئيسية بدلاً من ظهورها بعد البحث بالرقم القومي -->
                <div id="userInstructions" class="mt-4 d-none"></div>
            </div>

            <div id="empDashboard" class="main-card d-none animate__animated animate__fadeInUp">
                <div id="captureArea">
                    <!-- شعار الكلية يظهر في الجانب الأيسر مع التسمية تحته عند عرض الجدول وحفظه كصورة -->
                    <div class="d-flex align-items-start mb-3">
                        <div class="me-3 text-center">
                            <img src="https://tse2.mm.bing.net/th/id/OIP.yBtj4Qi_E9aiWlLY8KLDGwAAAA?rs=1&amp;pid=ImgDetMain" alt="شعار الكلية" style="height:80px;" class="mb-1">
                            <div class="fw-bold" style="font-size:0.85rem;">كلية الطب البيطري جامعة المنيا</div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h4 id="displayName" class="text-primary fw-bold mb-1"></h4>
                            <small class="text-muted" id="displayId"></small>
                            <div class="mt-2">
                                <!--
                                    يتم الآن عرض عدد أيام الملاحظات بدلاً من نص "يوم عمل" وذلك وفق طلب المستخدم،
                                    لتعكس عدد الأيام التي يشرف فيها الموظف على الملاحظات.
                                -->
                                <span class="badge bg-success" id="workDaysCount">0 عدد أيام الملاحظات</span>
                                <span class="badge bg-primary mx-2" id="swapDaysCount">0 تبديل مع</span>
                            </div>
                        </div>
                        <div class="no-print d-flex gap-2">
                            <button class="btn btn-success btn-sm" onclick="downloadSchedule()"><i class="fas fa-image me-1"></i> حفظ الجدول</button>
                            <button class="btn btn-primary btn-sm fw-bold" onclick="openSwapRequest()"><i class="fas fa-exchange-alt me-1"></i> طلب تبديل</button>
                            <button class="btn btn-outline-primary btn-sm" onclick="showEmpDetails()"><i class="fas fa-info-circle me-1"></i> التفاصيل</button>
                        </div>
                    </div>

                    <div class="progress-container">
                        <div id="workProgress" class="progress-bar" style="width: 0%"></div>
                    </div>
                    <!-- تعديل النص ليعكس عدد أيام الملاحظات بدلاً من أيام العمل -->
                    <div class="small text-muted text-center mb-3">الجدول الخاص بك </div>

                    <div class="schedule-table-container">
                        <table class="table table-bordered text-center align-middle schedule-table">
                            <thead class="table-light">
                                <tr>
                                    <th width="120">التاريخ</th>
                                    <th width="100">اليوم</th>
                                    <th width="100">الحالة</th>
                                    <th width="150">التفاصيل</th>
                                    <th width="80" class="no-print">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleTableBody"></tbody>
                        </table>
                    </div>

                    <!-- قسم التعليمات للمستخدم تم نقله ليظهر في الصفحة الرئيسية -->
                    
                    <div class="designer-footer show-on-capture" style="display:none;">
                        <!-- تحديث النص ليعكس التصميم الجذاب والمتغير الألوان الذي طلبه المستخدم -->
                        تصميم مهندس بولس سمير – تصميم جذاب بألوان متغيرة – مدير وحدة تكنولوجيا المعلومات بكلية الطب البيطري
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="adminDashboardView">
        <!-- زر التحكم في إظهار/إخفاء القائمة الجانبية/القائمة الأفقية -->
        <button id="adminSidebarToggle" type="button" class="btn btn-success text-white no-print position-fixed top-0 end-0 m-3 d-none" style="z-index:10500;" onclick="toggleAdminMenu()">
            <i class="fas fa-bars"></i>
        </button>

        <!-- قائمة الإجراءات السريعة -->
        <div class="floating-action-btn no-print animate__animated animate__fadeInUp" onclick="showQuickActions()">
            <i class="fas fa-bolt"></i>
        </div>

        <!-- القائمة الأفقية للوحة التحكم، تظهر عند الضغط على زر الشرط -->
        <div id="adminTopMenu" class="admin-top-menu no-print d-none">
            <a href="#" onclick="switchAdminTab('adm1', this)" title="الموظفين"><i class="fas fa-users icon"></i><span>الموظفين</span></a>
            <a href="#" onclick="switchAdminTab('adm2', this)" title="التوزيع"><i class="fas fa-calendar-alt icon"></i><span>التوزيع</span></a>
            <a href="#" onclick="switchAdminTab('adm3', this)" title="طلبات التبديل"><i class="fas fa-sync icon"></i><span>التبديل</span></a>
            <a href="#" onclick="switchAdminTab('adm4', this)" title="الجدول العام"><i class="fas fa-file-invoice icon"></i><span>الجدول</span></a>
            <a href="#" onclick="switchAdminTab('adm5', this)" title="الإحصائيات"><i class="fas fa-chart-pie icon"></i><span>الإحصائيات</span></a>
            <a href="#" onclick="switchAdminTab('adm6', this)" title="الملاحظات اليومية"><i class="fas fa-book-open icon"></i><span>الملاحظات</span></a>
            <a href="#" onclick="switchAdminTab('admInstr', this)" title="التعليمات"><i class="fas fa-info-circle icon"></i><span>التعليمات</span></a>
            <a href="#" onclick="logoutAdmin()" class="text-warning" title="خروج"><i class="fas fa-sign-out-alt icon"></i><span>خروج</span></a>
        </div>

        <div class="container-fluid">
            <div class="row">
                <div id="adminSidebar" class="col-md-2 admin-sidebar no-print d-none">
                    <div class="text-center mb-4 pt-3">
                        <!-- شعار الكلية مع التسمية تحته في لوحة الإدارة -->
                        <img src="https://tse2.mm.bing.net/th/id/OIP.yBtj4Qi_E9aiWlLY8KLDGwAAAA?rs=1&amp;pid=ImgDetMain" alt="شعار الكلية" style="height:70px;" class="mb-2">
                        <div class="fw-bold">كلية الطب البيطري جامعة المنيا</div>
                        <h5 class="fw-bold mt-2">لوحة التحكم</h5>
                        <small class="text-white-50" id="adminWelcome">مرحباً بك</small>
                    </div>
                    <nav class="nav flex-column">
                        <a class="admin-nav-link active" href="#" onclick="switchAdminTab('adm1', this)"><i class="fas fa-users me-2"></i> الموظفين</a>
                        <a class="admin-nav-link" href="#" onclick="switchAdminTab('adm2', this)"><i class="fas fa-calendar-alt me-2"></i> التوزيع</a>
                        <a class="admin-nav-link" href="#" onclick="switchAdminTab('adm3', this)"><i class="fas fa-sync me-2"></i> طلبات التبديل</a>
                        <a class="admin-nav-link" href="#" onclick="switchAdminTab('adm4', this)"><i class="fas fa-file-invoice me-2"></i> الجدول العام</a>
                        <a class="admin-nav-link" href="#" onclick="switchAdminTab('adm5', this)"><i class="fas fa-chart-pie me-2"></i> الإحصائيات</a>
                        <!-- رابط جديد لعرض جدول الملاحظات اليومية -->
                        <a class="admin-nav-link" href="#" onclick="switchAdminTab('adm6', this)"><i class="fas fa-book-open me-2"></i> الملاحظات اليومية</a>
                        <a class="admin-nav-link" href="#" onclick="switchAdminTab('admInstr', this)"><i class="fas fa-info-circle me-2"></i> التعليمات</a>
                        <hr class="bg-white mx-3">
                        <a class="admin-nav-link text-warning" href="#" onclick="logoutAdmin()"><i class="fas fa-sign-out-alt me-2"></i> خروج</a>
                    </nav>

                    <!-- عنصر اختيار اللون للتحكم في ألوان الواجهة -->
                    <div class="p-3">
                        <label for="colorPicker" class="form-label fw-bold text-white small">لون الواجهة</label>
                        <input type="color" id="colorPicker" class="form-control form-control-color w-100" value="#4caf50" title="اختر لون الواجهة">
                    </div>
                    
                    <div class="position-absolute bottom-0 start-0 end-0 p-3 text-center text-white-50 small">
                        v2.1.0
                    </div>
                </div>
                
                <div id="adminMain" class="col-md-10 p-4">
                    <div id="adminContent">
                        <div id="adm1" class="admin-tab">
                            <div class="main-card mt-0">
                                <h5 class="fw-bold border-bottom pb-3 mb-4"><i class="fas fa-users me-2"></i>إدارة الموظفين</h5>
                                
                                <div class="row g-3 mb-4 p-3 bg-light rounded">
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">اسم الموظف</label>
                                        <input type="text" id="aName" class="form-control" placeholder="أدخل الاسم الكامل">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">الرقم القومي</label>
                                        <input type="text" id="aId" class="form-control" placeholder="14 رقم">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">عضو هيئة تدريس؟</label>
                                        <div class="form-check mt-2">
                                            <input class="form-check-input" type="checkbox" id="aIsFaculty">
                                            <label class="form-check-label" for="aIsFaculty">نعم</label>
                                        </div>
                                    </div>
                                    <div class="col-md-2 d-flex align-items-end">
                                        <button class="btn btn-success w-100 py-2" onclick="addManualEmployee()"><i class="fas fa-user-plus me-2"></i>إضافة</button>
                                    </div>
                                </div>
                                
                                <div class="row mb-3 p-3 bg-light rounded">
                                    <div class="col-12">
                                        <h6 class="fw-bold mb-3"><i class="fas fa-file-excel me-2 text-success"></i>استيراد من ملف Excel</h6>
                                        <div class="input-group">
                                            <input type="file" id="excelFileInput" class="form-control" accept=".xlsx,.xls">
                                            <button class="btn btn-primary" onclick="importFromExcel()"><i class="fas fa-upload me-1"></i> استيراد</button>
                                        </div>
                                        <small class="text-muted">يجب أن يحتوي الملف على عمودين: "الاسم" و "الرقم القومي"</small>
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="fw-bold m-0">قائمة الموظفين المسجلين</h6>
                                    <div class="small text-muted" id="empCount">0 موظف</div>
                                </div>
                                <div id="adminEmpsList" class="list-group" style="max-height: 500px; overflow-y: auto;"></div>
                            </div>
                        </div>

                        <div id="adm3" class="admin-tab d-none">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="main-card h-100">
                                        <h6 class="fw-bold mb-3"><i class="fas fa-clock text-warning me-2"></i>طلبات بانتظار الموافقة</h6>
                                        <div id="pendingSwapsList" class="mb-3" style="max-height: 400px; overflow-y: auto;"></div>
                                        <div class="text-center">
                                            <button class="btn btn-outline-warning btn-sm" onclick="refreshSwaps()"><i class="fas fa-sync me-1"></i>تحديث</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="main-card h-100">
                                        <h6 class="fw-bold mb-3"><i class="fas fa-check-circle text-success me-2"></i>طلبات مكتملة</h6>
                                        <div id="completedSwapsList" class="mb-3" style="max-height: 400px; overflow-y: auto;"></div>
                                        <div class="text-center">
                                            <button class="btn btn-outline-success btn-sm" onclick="exportSwaps()"><i class="fas fa-download me-1"></i>تصدير</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- قسم التبديلات اليدوية للسماح للمسؤول بإنشاء وتعديل التبديلات مباشرة -->
                            <div class="main-card mt-3">
                                <h6 class="fw-bold mb-3"><i class="fas fa-handshake text-info me-2"></i>التبديلات اليدوية</h6>
                                <div class="mb-2">
                                    <button class="btn btn-primary btn-sm" onclick="window.showManualSwapModal()"><i class="fas fa-plus me-1"></i> إضافة تبديل يدوي</button>
                                </div>
                                <div id="manualSwapsList" style="max-height: 400px; overflow-y: auto;"></div>
                            </div>
                        </div>

                        <div id="adm4" class="admin-tab d-none">
                            <div class="main-card mt-0">
                                <div class="d-flex justify-content-between mb-3 no-print">
                                    <h5 class="fw-bold"><i class="fas fa-file-invoice me-2"></i>الجدول العام المجمع</h5>
                                    <div>
                                        <button class="btn btn-dark me-2" onclick="window.print()"><i class="fas fa-print me-1"></i> طباعة</button>
                                        <button class="btn btn-success" onclick="exportMasterReport()"><i class="fas fa-file-excel me-1"></i> تصدير Excel</button>
                                    </div>
                                </div>
                                <div id="masterReportArea" style="overflow-x: auto;"></div>
                            </div>
                        </div>

                        <div id="adm5" class="admin-tab d-none">
                            <div class="main-card mt-0">
                                <h5 class="fw-bold border-bottom pb-3 mb-4"><i class="fas fa-chart-pie me-2"></i>الإحصائيات والتقارير</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <canvas id="statsChart" height="250"></canvas>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="p-3 bg-light rounded">
                                            <h6 class="fw-bold">ملخص سريع</h6>
                                            <div id="statsSummary" class="mt-3"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="adm2" class="admin-tab d-none">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="main-card mt-0 h-100">
                                        <h5 class="fw-bold mb-3"><i class="fas fa-calendar me-2"></i>إدارة التواريخ</h5>
                                        <div class="input-group mb-3">
                                            <input type="date" id="newDate" class="form-control">
                                            <button class="btn btn-primary" onclick="addDate()"><i class="fas fa-plus"></i></button>
                                        </div>
                                        <div class="mb-3">
                                            <button class="btn btn-outline-secondary btn-sm w-100 mb-2" onclick="addMultipleDates()"><i class="fas fa-calendar-plus me-1"></i>إضافة نطاق تواريخ</button>
                                        </div>
                                        <h6 class="fw-bold mt-4">التواريخ المضافة</h6>
                                        <div id="adminDatesList" class="d-flex flex-wrap gap-2 mt-3" style="max-height: 200px; overflow-y: auto;"></div>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="main-card mt-0">
                                        <h5 class="fw-bold mb-3"><i class="fas fa-user-check me-2"></i>البحث والتوزيع</h5>
                                        <div class="input-group mb-3">
                                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                                            <input type="text" id="assignSearch" class="form-control" placeholder="ابحث عن موظف..." onkeyup="filterAssignSearch()">
                                        </div>
                                        <div id="assignSearchResults" class="list-group" style="max-height: 400px; overflow-y: auto;"></div>
                                        <!-- جدول التوزيع: يعرض اسم الموظف والأيام المعينة بعلامة صح -->
                                        <!-- قسم رفع ملف الملاحظات للموظفين -->
                                        <div class="mb-4 mt-4">
                                            <h6 class="fw-bold"><i class="fas fa-file-import me-2"></i> رفع ملف الملاحظات</h6>
                                            <input type="file" id="notesFile" accept=".xlsx,.xls,.csv" class="form-control mb-2" />
                                            <button class="btn btn-success w-100" onclick="uploadNotesFile()"><i class="fas fa-upload me-1"></i> استيراد الملاحظات</button>
                                            <small class="text-muted d-block mt-2">الملف يجب أن يحتوي على عمود للاسم وعمود للتواريخ (مفصولة بفواصل)</small>
                                        </div>
                                        <div id="assignmentOverview" class="mt-4"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- علامة تبويب جديدة لعرض الملاحظات اليومية -->
    <div id="adm6" class="admin-tab d-none">
        <div class="main-card mt-0">
            <h5 class="fw-bold mb-3"><i class="fas fa-calendar-day me-2"></i> جدول الملاحظات اليومي</h5>
            <!-- صف اختيار التاريخ وأزرار العرض والطباعة، تم إضافة فئة للتحكم بالطباعة وتحسين المحاذاة -->
            <div class="row g-3 align-items-end mb-3 justify-content-center daily-notes-control-row">
                <div class="col-md-4">
                    <label class="form-label fw-bold">اختر اليوم</label>
                    <input type="date" id="dailyNotesDate" class="form-control">
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary w-100" onclick="renderDailyNotes()"><i class="fas fa-search me-1"></i> عرض</button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-dark w-100" onclick="printDailyNotes()"><i class="fas fa-print me-1"></i> طباعة</button>
                </div>
            </div>
            <!-- ترويسة الطباعة لجدول الملاحظات اليومية، تظهر فقط عند الطباعة -->
            <div id="dailyNotesHeader" class="d-flex align-items-center mb-3" style="display:none;">
                <div class="me-3">
                    <!-- شعار الكلية (يتم تحميله من الرابط المباشر) -->
                    <img src="https://tse2.mm.bing.net/th/id/OIP.yBtj4Qi_E9aiWlLY8KLDGwAAAA?rs=1&amp;pid=ImgDetMain" alt="شعار الكلية" style="height:80px;">
                </div>
                <div class="flex-grow-1">
                    <h5 class="fw-bold mb-1">كلية الطب البيطري جامعة المنيا</h5>
                    <!-- سيتم تحديث هذا العنصر بتاريخ اليوم المختار -->
                    <div id="dailyNotesDateTitle" class="fw-bold"></div>
                </div>
            </div>
            <div id="dailyNotesTableArea" class="table-responsive"></div>
            <!-- يظهر هذا النص فقط عند الطباعة -->
            <div id="dailyNotesFooter" class="mt-4 text-center" style="display:none;">
                تصميم مهندس بولس سمير مدير وحدة تكنولوجيا المعلومات بكلية الطب البيطري جامعة المنيا
            </div>
        </div>
    </div>

    <!-- تبويب جديد لإدارة التعليمات -->
    <div id="admInstr" class="admin-tab d-none">
        <div class="main-card mt-0">
            <h5 class="fw-bold mb-3"><i class="fas fa-info-circle me-2"></i> إدارة التعليمات</h5>
            <div class="mb-3">
                <label for="instructionInput" class="form-label fw-bold">أضف تعليمات جديدة</label>
                <textarea id="instructionInput" class="form-control" rows="2" placeholder="أدخل تعليمات..."></textarea>
                <button class="btn btn-primary mt-2" onclick="addInstruction()"><i class="fas fa-plus me-1"></i> إضافة</button>
            </div>
            <ul id="instructionList" class="list-unstyled"></ul>
        </div>
    </div>

    <div id="loginModal" class="d-none position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-75" style="z-index:10000">
        <div class="d-flex align-items-center justify-content-center h-100">
            <div class="main-card mx-auto animate__animated animate__zoomIn" style="max-width:400px">
                <div class="text-center mb-4">
                    <i class="fas fa-lock fa-3x text-primary mb-3"></i>
                    <h5 class="fw-bold">دخول الإدارة</h5>
                    <p class="text-muted small">أدخل كلمة المرور للوصول إلى لوحة التحكم</p>
                </div>
                <input type="password" id="adminPass" class="form-control my-3 text-center py-3" placeholder="كلمة المرور">
                <button class="btn btn-dark w-100 py-2" onclick="checkAdmin()"><i class="fas fa-sign-in-alt me-2"></i>دخول</button>
                <div class="text-center mt-3">
                    <button class="btn btn-link text-muted small" onclick="hideLoginModal()">إلغاء</button>
                </div>
            </div>
        </div>
    </div>

    <div id="quickActionsModal" class="d-none position-fixed bottom-0 start-0 w-100" style="z-index:9990">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-4">
                    <div class="main-card animate__animated animate__slideInUp">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-bold m-0">إجراءات سريعة</h6>
                            <button class="btn btn-sm btn-outline-secondary" onclick="hideQuickActions()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="list-group">
                            <a href="#" class="list-group-item list-group-item-action" onclick="exportMasterReport()"><i class="fas fa-file-excel me-2"></i>تصدير Excel</a>
                            <a href="#" class="list-group-item list-group-item-action" onclick="window.print()"><i class="fas fa-print me-2"></i>طباعة الجدول</a>
                            <a href="#" class="list-group-item list-group-item-action" onclick="refreshSwaps()"><i class="fas fa-sync me-2"></i>تحديث الطلبات</a>
                            <a href="#" class="list-group-item list-group-item-action" onclick="showHelp()"><i class="fas fa-question-circle me-2"></i>المساعدة</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // إعدادات Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBbslcuBI0eXaidzuAL4gqtyiWv48tp7ME",
            authDomain: "gradusum.firebaseapp.com",
            databaseURL: "https://gradusum-default-rtdb.firebaseio.com",
            projectId: "gradusum",
            // تم تصحيح اسم حاوية التخزين ليعمل مع Firebase Storage بشكل صحيح
            storageBucket: "gradusum.appspot.com",
            messagingSenderId: "869226902808",
            appId: "1:869226902808:web:ae22f03cc9f2a7a796da6d",
            measurementId: "G-MS9FPE6HZW"
        };

        let db, auth, currentEmpData, allEmployees = [], allDates = [], statsChart, firebaseInitialized = false;
        // مصفوفة لتخزين التبديلات اليدوية التي يقوم بها المسؤول. يتم تحميلها من التخزين المحلي أو Firebase عند التهيئة.
        let manualSwaps = [];

        async function init() {
            try {
                console.log('🚀 جاري تهيئة النظام...');
                
                // تحميل التبديلات اليدوية من التخزين المحلي قبل بدء أي عمليات
                if (typeof loadManualSwaps === 'function') {
                    manualSwaps = loadManualSwaps();
                }

                setTimeout(() => {
                    const loadingOverlay = document.getElementById('loadingOverlay');
                    if(loadingOverlay && loadingOverlay.style.display !== 'none') {
                        loadingOverlay.style.display = 'none';
                        document.getElementById('userInterface').style.display = 'block';
                        console.log('✅ تم إظهار الواجهة الرئيسية');
                    }
                }, 2000);
                
                try {
                    if (typeof firebase === 'undefined') {
                        throw new Error('Firebase library not loaded');
                    }
                    
                    if (!firebase.apps.length) {
                        firebase.initializeApp(firebaseConfig);
                        console.log('✅ تم تهيئة Firebase بنجاح');
                    } else {
                        firebase.app();
                        console.log('✅ تم استخدام تطبيق Firebase الموجود');
                    }
                    
                    db = firebase.firestore();
                    
                    const settings = {
                        cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED,
                        ignoreUndefinedProperties: true
                    };
                    db.settings(settings);
                    
                    try {
                        await firebase.firestore().enablePersistence({
                            synchronizeTabs: true
                        });
                        console.log('✅ تم تفعيل التخزين المؤقت');
                    } catch (persistenceError) {
                        console.warn('⚠️ تعذر تفعيل التخزين المؤقت:', persistenceError.code);
                    }
                    
                    try {
                        auth = firebase.auth();
                        await auth.signInAnonymously();
                        console.log('✅ تم تسجيل الدخول كضيف');
                        
                        const currentUser = auth.currentUser;
                        if (currentUser) {
                            console.log('👤 المستخدم المجهول:', currentUser.uid);
                        }
                    } catch (authError) {
                        console.warn('⚠️ تعذر تسجيل الدخول كضيف:', authError);
                    }
                    
                    firebaseInitialized = true;
                    
                    try {
                        console.log('📡 جاري اختبار الاتصال بقاعدة البيانات...');
                        
                        const testRef = db.collection('testConnection').doc('test');
                        const testDoc = await testRef.get();
                        
                        if (!testDoc.exists) {
                            await testRef.set({
                                timestamp: new Date().toISOString(),
                                message: 'Test connection successful',
                                app: 'Exam Management System'
                            });
                        }
                        
                        console.log('✅ اتصال Firestore يعمل بنجاح');

                        await loadData();

                        // بعد تحميل البيانات، قم بمزامنة التعليمات من Firebase إلى التخزين المحلي
                        if (typeof syncInstructionsFromFirebase === 'function') {
                            await syncInstructionsFromFirebase();
                        }
                        // مزامنة التبديلات اليدوية من Firebase إلى التخزين المحلي
                        if (typeof syncManualSwapsFromFirebase === 'function') {
                            await syncManualSwapsFromFirebase();
                        }
                        
                    } catch (firestoreError) {
                        console.error('❌ خطأ في اتصال Firestore:', firestoreError);
                        
                        if (firestoreError.code === 'permission-denied') {
                            showErrorMessage('خطأ في الصلاحيات. يجب تعديل قواعد الأمان في Firebase Console.');
                        } else if (firestoreError.code === 'failed-precondition') {
                            showErrorMessage('قاعدة البيانات غير مهيئة. تأكد من إنشاء Firestore في مشروعك.');
                        } else if (firestoreError.code === 'unavailable') {
                            console.log('🌐 لا يوجد اتصال بالإنترنت - استخدام وضع عدم الاتصال');
                            loadMockData();
                        } else {
                            console.error('❌ خطأ غير معروف:', firestoreError);
                            showErrorMessage(`خطأ في الاتصال بقاعدة البيانات: ${firestoreError.message}`);
                            loadMockData();
                        }
                    }
                    
                } catch (firebaseError) {
                    console.error('❌ خطأ في Firebase:', firebaseError);
                    showErrorMessage('خطأ في تهيئة Firebase. يتم استخدام وضع عدم الاتصال.');
                    
                    loadMockData();
                    
                    setTimeout(() => {
                        document.getElementById('loadingOverlay').style.display = 'none';
                        document.getElementById('userInterface').style.display = 'block';
                    }, 1000);
                }
                
            } catch (error) {
                console.error('❌ خطأ فادح:', error);
                showErrorMessage('حدث خطأ في النظام');
            }
        }

        async function loadData() {
            try {
                if (!firebaseInitialized) {
                    console.log('⚠️ Firebase غير مهيئ، استخدام البيانات المحلية');
                    loadMockData();
                    return;
                }
                
                console.log('📥 جاري تحميل البيانات...');
                
                try {
                    const employeesSnapshot = await db.collection('employees').get();
                    allEmployees = [];
                    employeesSnapshot.forEach(doc => {
                        const data = doc.data();
                        allEmployees.push({
                            id: doc.id,
                            nationalId: doc.id,
                            name: data.name || 'غير معروف',
                            isFaculty: data.isFaculty || false,
                            schedule: data.schedule || [],
                            pendingSwaps: data.pendingSwaps || [],
                            notifications: data.notifications || [],
                            createdAt: data.createdAt || new Date().toISOString(),
                            lastUpdated: data.lastUpdated || new Date().toISOString()
                        });
                    });
                    console.log(`✅ تم تحميل ${allEmployees.length} موظف`);
                } catch (empError) {
                    console.error('❌ خطأ في تحميل الموظفين:', empError);
                    if (empError.code === 'permission-denied') {
                        console.error('⚠️ خطأ في الصلاحيات، تأكد من قواعد Firestore');
                        Swal.fire({
                            icon: 'error',
                            title: 'خطأ في الصلاحيات',
                            html: `
                                <div class="text-start">
                                    <p>يجب تعديل قواعد الأمان في Firebase Console:</p>
                                    <div style="text-align: left; direction: ltr; background: #f1f1f1; padding: 10px; border-radius: 5px; font-family: monospace; overflow: auto;">
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;
    }
  }
}
                                    </div>
                                    <p class="mt-3 small text-muted">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        هذا للإعدادات الأولية فقط. قم بتقييد الصلاحيات لاحقاً.
                                    </p>
                                </div>
                            `,
                            width: 600
                        });
                    }
                    loadMockData();
                    return;
                }
                
                try {
                    const datesDoc = await db.collection('settings').doc('examDates').get();
                    if (datesDoc.exists) {
                        allDates = datesDoc.data().dates || [];
                        allDates.sort();
                        console.log(`✅ تم تحميل ${allDates.length} تاريخ`);
                    } else {
                        try {
                            await db.collection('settings').doc('examDates').set({ 
                                dates: [],
                                lastUpdated: new Date().toISOString()
                            });
                            allDates = [];
                            console.log('✅ تم إنشاء مستند التواريخ');
                        } catch (dateError) {
                            console.warn('⚠️ تعذر إنشاء مستند التواريخ:', dateError);
                        }
                    }
                } catch (dateLoadError) {
                    console.warn('⚠️ تعذر تحميل التواريخ:', dateLoadError);
                    allDates = [];
                }
                
                renderAdminEmps();
                renderAdminDates();
                updateStats();
                
                if (currentEmpData) {
                    const updatedEmp = allEmployees.find(e => e.nationalId === currentEmpData.nationalId);
                    if (updatedEmp) {
                        currentEmpData = updatedEmp;
                        renderEmpUI();
                    }
                }
                
                saveToLocalStorage();
                
            } catch (error) {
                console.error('❌ خطأ في تحميل البيانات:', error);
                loadMockData();
            }
        }

        function loadMockData() {
            console.log('📂 جاري التحميل ببيانات تجريبية...');
            
            const savedEmployees = localStorage.getItem('employees');
            const savedDates = localStorage.getItem('examDates');
            
            if (savedEmployees) {
                allEmployees = JSON.parse(savedEmployees);
                console.log(`✅ تم تحميل ${allEmployees.length} موظف من التخزين المحلي`);
            } else {
                allEmployees = [
                    {
                        nationalId: "12345678901234",
                        name: "أحمد محمد",
                        schedule: [],
                        pendingSwaps: [],
                        notifications: [],
                        createdAt: new Date().toISOString(),
                        lastUpdated: new Date().toISOString()
                    },
                    {
                        nationalId: "98765432109876",
                        name: "محمد علي",
                        schedule: [],
                        pendingSwaps: [],
                        notifications: [],
                        createdAt: new Date().toISOString(),
                        lastUpdated: new Date().toISOString()
                    }
                ];
                console.log('✅ تم تحميل بيانات تجريبية افتراضية');
            }
            
            if (savedDates) {
                allDates = JSON.parse(savedDates);
                console.log(`✅ تم تحميل ${allDates.length} تاريخ من التخزين المحلي`);
            } else {
                const today = new Date();
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();
                allDates = [];
                
                for (let i = 1; i <= 5; i++) {
                    const day = Math.floor(Math.random() * 28) + 1;
                    const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    allDates.push(dateStr);
                }
                
                allDates.sort();
            }
            
            renderAdminEmps();
            renderAdminDates();
            updateStats();
            
            console.log('✅ تم التحميل بنجاح (بيانات محلية)');
        }

        function saveToLocalStorage() {
            try {
                localStorage.setItem('employees', JSON.stringify(allEmployees));
                localStorage.setItem('examDates', JSON.stringify(allDates));
                localStorage.setItem('lastSync', new Date().toISOString());
                console.log('💾 تم حفظ البيانات محلياً');
            } catch (error) {
                console.warn('⚠️ تعذر حفظ البيانات محلياً:', error);
            }
        }

        async function saveDataToFirebase() {
            if (!firebaseInitialized) {
                console.log('⚠️ Firebase غير مهيئ، حفظ محلي فقط');
                saveToLocalStorage();
                return false;
            }
            
            try {
                console.log('💾 جاري حفظ البيانات في Firebase...');

                saveToLocalStorage();
                
                const batch = db.batch();
                
                allEmployees.forEach(emp => {
                    const empRef = db.collection('employees').doc(emp.nationalId);
                    const empData = {
                        name: emp.name,
                        nationalId: emp.nationalId,
                        // حفظ حالة العضوية في هيئة التدريس لاسترجاعها لاحقاً
                        isFaculty: emp.isFaculty || false,
                        schedule: emp.schedule || [],
                        pendingSwaps: emp.pendingSwaps || [],
                        notifications: emp.notifications || [],
                        createdAt: emp.createdAt || new Date().toISOString(),
                        lastUpdated: new Date().toISOString()
                    };
                    batch.set(empRef, empData, { merge: true });
                });
                
                const datesRef = db.collection('settings').doc('examDates');
                batch.set(datesRef, { 
                    dates: allDates,
                    lastUpdated: new Date().toISOString()
                }, { merge: true });
                
                await batch.commit();
                console.log('✅ تم حفظ البيانات في Firebase بنجاح');
                
                localStorage.setItem('lastFirebaseSync', new Date().toISOString());

                if (typeof renderAdminEmps === 'function') renderAdminEmps();
                if (typeof renderAdminDates === 'function') renderAdminDates();
                if (typeof renderAdminSwaps === 'function') renderAdminSwaps();
                if (typeof updateStats === 'function') updateStats();
                if (typeof renderMasterReport === 'function') renderMasterReport();
                if (typeof currentEmpData !== 'undefined' && currentEmpData) {
                    const currentUpdated = allEmployees.find(e => e.nationalId === currentEmpData.nationalId);
                    if (currentUpdated) {
                        currentEmpData = currentUpdated;
                    }
                    if (typeof renderEmpUI === 'function') renderEmpUI();
                    if (typeof updateNotificationBadge === 'function') updateNotificationBadge();
                }

                return true;
                
            } catch (error) {
                console.error('❌ خطأ في حفظ البيانات في Firebase:', error);
                
                try {
                    for (const emp of allEmployees) {
                        await db.collection('employees').doc(emp.nationalId).set({
                            name: emp.name,
                            nationalId: emp.nationalId,
                            schedule: emp.schedule || [],
                            pendingSwaps: emp.pendingSwaps || [],
                            notifications: emp.notifications || [],
                            createdAt: emp.createdAt || new Date().toISOString(),
                            lastUpdated: new Date().toISOString()
                        }, { merge: true });
                    }
                    
                    await db.collection('settings').doc('examDates').set({ 
                        dates: allDates,
                        lastUpdated: new Date().toISOString()
                    }, { merge: true });
                    
                    console.log('✅ تم حفظ البيانات بشكل فردي');
                    
                    localStorage.setItem('lastFirebaseSync', new Date().toISOString());

                    if (typeof renderAdminEmps === 'function') renderAdminEmps();
                    if (typeof renderAdminDates === 'function') renderAdminDates();
                    if (typeof renderAdminSwaps === 'function') renderAdminSwaps();
                    if (typeof updateStats === 'function') updateStats();
                    if (typeof currentEmpData !== 'undefined' && currentEmpData) {
                        const currentUpdated = allEmployees.find(e => e.nationalId === currentEmpData.nationalId);
                        if (currentUpdated) {
                            currentEmpData = currentUpdated;
                        }
                        if (typeof renderEmpUI === 'function') renderEmpUI();
                        if (typeof updateNotificationBadge === 'function') updateNotificationBadge();
                    }

                    return true;
                    
                } catch (individualError) {
                    console.error('❌ فشل في الحفظ الفردي:', individualError);
                    
                    saveToLocalStorage();
                    
                    Swal.fire({
                        icon: 'warning',
                        title: 'تنبيه',
                        text: 'تعذر حفظ البيانات على السحابة. تم الحفظ محلياً فقط.',
                        timer: 3000,
                        showConfirmButton: false
                    });
                    
                    return false;
                }
            }
        }

        function showErrorMessage(message) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            
            loadingOverlay.innerHTML = `
                <div class="text-center p-4 animate__animated animate__fadeIn">
                    <div class="mb-4">
                        <i class="fas fa-exclamation-triangle fa-4x text-warning mb-3"></i>
                        <h4 class="text-white mb-3">حدث خطأ</h4>
                        <p class="text-white-75 mb-4">${message}</p>
                    </div>
                    
                    <div class="bg-white bg-opacity-10 rounded p-4 mb-4">
                        <h6 class="text-white mb-3"><i class="fas fa-cogs me-2"></i>خطوات الحل:</h6>
                        <ol class="text-white-75 text-start" style="max-width: 500px; margin: 0 auto;">
                            <li class="mb-2">تأكد من اتصالك بالإنترنت</li>
                            <li class="mb-2">افتح <a href="https://console.firebase.google.com/" target="_blank" class="text-warning">Firebase Console</a></li>
                            <li class="mb-2">اذهب إلى قسم Firestore Database</li>
                            <li class="mb-2">اضغط على "Rules" وأعد الكتابة كما في المربع أدناه</li>
                        </ol>
                        
                        <div class="mt-4">
                            <h6 class="text-white mb-2">قواعد Firestore المطلوبة:</h6>
                            <div style="text-align: left; direction: ltr; background: rgba(0,0,0,0.3); color: #fff; padding: 15px; border-radius: 8px; max-width: 600px; margin: 0 auto; overflow: auto; font-family: monospace;">
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;
    }
  }
}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <button class="btn btn-light me-2" onclick="location.reload()">
                            <i class="fas fa-redo me-1"></i>إعادة تحميل
                        </button>
                        <button class="btn btn-outline-light" onclick="continueOffline()">
                            <i class="fas fa-wifi-slash me-1"></i>المتابعة بدون اتصال
                        </button>
                    </div>
                </div>
            `;
        }

        function continueOffline() {
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('userInterface').style.display = 'block';
            loadMockData();
        }

        function getDayAr(dateStr) {
            try {
                const date = new Date(dateStr);
                const days = ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
                return days[date.getDay()] || dateStr;
            } catch (e) {
                return dateStr;
            }
        }

        /**
         * تحديد جنس الموظف بناءً على الرقم القومي المصري.
         * في الرقم القومي المصري، الرقم الثالث عشر (المؤشر 12 في السلسلة) يحدد الجنس:
         * الأرقام الفردية تشير إلى ذكر، والأرقام الزوجية تشير إلى أنثى.
         * @param {string} nid الرقم القومي (14 رقم)
         * @returns {string} 'male' أو 'female'
         */
        function getGenderFromNationalId(nid) {
            try {
                if (!nid || nid.length < 13) return 'male';
                const digit = parseInt(nid.charAt(12));
                if (isNaN(digit)) return 'male';
                return (digit % 2 === 0) ? 'female' : 'male';
            } catch (e) {
                return 'male';
            }
        }

        /**
         * إرجاع اسم الموظف مرفقاً باللقب المناسب وفق الجنس وعضوية هيئة التدريس.
         * إذا كان الموظف عضو هيئة تدريس، يتم إلحاق "أستاذ دكتور" قبل الاسم.
         * إذا لم يكن عضواً بهيئة التدريس، يتم استخدام "أستاذ" للذكر و "أستاذة" للأنثى.
         * @param {object} emp كائن الموظف يحتوي على name و nationalId و isFaculty
         * @returns {string} الاسم مع اللقب الملائم
         */
        function getNameWithPrefix(emp) {
            if (!emp) return '';
            const gender = getGenderFromNationalId(emp.nationalId || '');
            if (emp.isFaculty) {
                return `أستاذ دكتور ${emp.name}`;
            }
            if (gender === 'female') {
                return `أستاذة ${emp.name}`;
            }
            return `أستاذ ${emp.name}`;
        }

        function searchEmployee() {
            const id = document.getElementById('nidInput').value.trim();
            
            if(!id) {
                Swal.fire('تنبيه', 'يرجى إدخال الرقم القومي', 'warning');
                return;
            }
            
            const emp = allEmployees.find(e => e.nationalId === id);
            
            if(emp) {
                currentEmpData = emp;
                renderEmpUI();
                
                document.getElementById('searchSection').classList.add('animate__fadeOutUp');
                setTimeout(() => {
                    document.getElementById('searchSection').classList.add('d-none');
                    document.getElementById('searchSection').classList.remove('animate__fadeOutUp');
                    
                    document.getElementById('empDashboard').classList.remove('d-none');
                    document.getElementById('empDashboard').classList.add('animate__fadeInUp');
                }, 300);
                
                updateNotificationBadge();
                // إذا كان لدى المستخدم طلبات تبديل معلقة، اعرض الإشعارات تلقائياً
                const incomingSwaps = allEmployees.reduce((count, employee) => {
                    return count + (employee.pendingSwaps || []).filter(sw => sw.targetId === currentEmpData.nationalId && sw.status === 'pending').length;
                }, 0);
                if (incomingSwaps > 0) {
                    setTimeout(() => {
                        try {
                            showNotifications();
                        } catch (err) {
                            console.error('تعذر عرض الإشعارات تلقائياً:', err);
                        }
                    }, 500);
                }
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'غير مسجل',
                    text: 'الرقم القومي غير مسجل في النظام',
                    confirmButtonText: 'حسناً',
                    customClass: {
                        confirmButton: 'btn btn-primary'
                    }
                });
            }
        }

        function renderEmpUI() {
            if(!currentEmpData) return;
            
            // عرض الاسم باللقب المناسب بناءً على الجنس وعضوية هيئة التدريس
            const formattedName = getNameWithPrefix(currentEmpData);
            document.getElementById('displayName').innerText = formattedName || currentEmpData.name || 'غير معروف';
            document.getElementById('displayId').innerText = `الرقم القومي: ${currentEmpData.nationalId}`;
            
            const schedule = currentEmpData.schedule || [];
            const workDays = schedule.filter(s => !s.wasSwappedOut).length;
            const swapDays = schedule.filter(s => s.isSwapped || s.wasSwappedOut).length;
            
            // عرض عدد أيام الملاحظات بدلاً من "يوم عمل" بناءً على طلب المستخدم
            document.getElementById('workDaysCount').innerText = `${workDays} عدد أيام الملاحظات`;
            document.getElementById('swapDaysCount').innerText = `${swapDays} تبديل مع`;
            
            const progressPercent = allDates.length > 0 ? (workDays / allDates.length * 100) : 0;
            document.getElementById('workProgress').style.width = `${progressPercent}%`;
            
            const tbody = document.getElementById('scheduleTableBody');
            tbody.innerHTML = '';
            
            schedule.forEach(s => {
                const row = document.createElement('tr');
                if (s.isSwapped || s.wasSwappedOut) {
                    row.className = 'swapped-row';
                }
                // عرض اسم الزميل الذي تم التبديل معه باللقب المناسب إذا وجد
                let partnerDisplay = '-';
                if (s.swappedWith) {
                    const match = allEmployees.find(e => e.name === s.swappedWith);
                    partnerDisplay = match ? getNameWithPrefix(match) : s.swappedWith;
                }
                row.innerHTML = `
                    <td>${s.date}</td>
                    <td>${getDayAr(s.date)}</td>
                    <td>
                        ${(s.wasSwappedOut || s.isSwapped) ? 
                            '<span class="badge bg-primary">تبديل مع</span>' : 
                            '<span class="badge bg-success">أساسي</span>'}
                    </td>
                    <td>${partnerDisplay}</td>
                    <td class="no-print">
                        ${s.isSwapped || s.wasSwappedOut ? 
                            `<button type="button" class="btn btn-sm btn-outline-info" onclick="showSwapDetails('${s.date}')">
                                <i class="fas fa-info-circle"></i>
                            </button>` : 
                            `<button type="button" class="btn btn-sm btn-outline-primary" onclick="requestSwapForDate('${s.date}')">
                                <i class="fas fa-exchange-alt"></i>
                            </button>`}
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            if (schedule.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-4 text-muted">
                            <i class="fas fa-calendar-times fa-2x mb-3"></i>
                            <p>لا توجد أيام ملاحظات مخصصة</p>
                        </td>
                    </tr>
                `;
            }
            
            updateNotificationBadge();
        }

        function openSwapRequest() {
            if(!currentEmpData) {
                Swal.fire({
                    icon: 'warning',
                    title: 'يجب البحث أولاً',
                    text: 'يرجى البحث عن الموظف أولاً لطلب تبديل',
                    confirmButtonText: 'حسناً'
                });
                return;
            }
            
            const myDates = (currentEmpData.schedule || []).filter(s => !s.wasSwappedOut).map(s => s.date);
            
            if(myDates.length === 0) {
                Swal.fire({
                    icon: 'info',
                    title: 'لا يوجد أيام',
                    text: 'ليس لديك أيام ملاحظات متاحة للتبديل',
                    confirmButtonText: 'حسناً'
                });
                return;
            }
            
            Swal.fire({
                title: 'طلب تبديل ذكي',
                html: `
                    <div class="text-start">
                        <label class="form-label fw-bold">اختر اليوم من جدولك:</label>
                        <select id="swDate" class="form-select mb-3" onchange="updateAvailableEmps()">
                            <option value="">-- اختر التاريخ --</option>
                            ${myDates.map(d => `<option value="${d}">${d} (${getDayAr(d)})</option>`).join('')}
                        </select>
                        <label class="form-label fw-bold">الزملاء المتاحين (ليس لديهم ملاحظات هذا اليوم):</label>
                        <select id="swTarget" class="form-select"></select>
                        <div class="mt-3">
                            <label class="form-label fw-bold">رسالة إضافية (اختياري):</label>
                            <textarea id="swMessage" class="form-control" rows="2" placeholder="أضف رسالة توضيحية..."></textarea>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'إرسال الطلب',
                cancelButtonText: 'إلغاء',
                didOpen: () => {
                    window.updateAvailableEmps = () => {
                        const date = document.getElementById('swDate').value;
                        if(!date) return;
                        
                        const available = allEmployees.filter(e => 
                            e.nationalId !== currentEmpData.nationalId && 
                            !(e.schedule || []).some(s => s.date === date && !s.wasSwappedOut)
                        );
                        
                        const select = document.getElementById('swTarget');
                        select.innerHTML = available.length > 0 ? 
                            available.map(e => `<option value="${e.nationalId}">${getNameWithPrefix(e)}</option>`).join('') : 
                            '<option value="">لا يوجد زملاء متاحين</option>';
                    };
                    
                    window.updateAvailableEmps();
                },
                preConfirm: async () => {
                    const date = document.getElementById('swDate').value;
                    const targetId = document.getElementById('swTarget').value;
                    
                    if(!date || !targetId) {
                        Swal.showValidationMessage('يرجى اختيار التاريخ والزميل');
                        return false;
                    }
                    
                    const target = allEmployees.find(e => e.nationalId === targetId);
                    if (!target) {
                        Swal.showValidationMessage('الزميل المختار غير موجود');
                        return false;
                    }
                    
                    const message = document.getElementById('swMessage').value;
                    
                    const requestId = `swap_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    const request = {
                        requestId: requestId,
                        myDate: date,
                        targetId: targetId,
                        // استخدم الاسم مع اللقب للهدف
                        targetName: getNameWithPrefix(target),
                        requesterId: currentEmpData.nationalId,
                        // استخدم الاسم مع اللقب للمرسل
                        requesterName: getNameWithPrefix(currentEmpData),
                        message: message || '',
                        status: 'pending',
                        timestamp: new Date().toISOString()
                    };
                    
                    return await addSwapRequest(request);
                }
            }).then(async result => {
                if(result.isConfirmed) {
                    if (result.value) {
                        Swal.fire({
                            icon: 'success',
                            title: 'تم الإرسال',
                            text: 'تم إرسال طلب التبديل بنجاح',
                            timer: 2000,
                            showConfirmButton: false
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'خطأ',
                            text: 'تعذر إرسال طلب التبديل',
                            timer: 2000,
                            showConfirmButton: false
                        });
                    }
                }
            });
        }

        async function addSwapRequest(request) {
            try {
                const empIndex = allEmployees.findIndex(e => e.nationalId === currentEmpData.nationalId);
                if (empIndex !== -1) {
                    if (!allEmployees[empIndex].pendingSwaps) {
                        allEmployees[empIndex].pendingSwaps = [];
                    }
                    allEmployees[empIndex].pendingSwaps.push(request);
                    
                    currentEmpData.pendingSwaps = allEmployees[empIndex].pendingSwaps;
                }
                
                const targetIndex = allEmployees.findIndex(e => e.nationalId === request.targetId);
                if (targetIndex !== -1) {
                    if (!allEmployees[targetIndex].notifications) {
                        allEmployees[targetIndex].notifications = [];
                    }
                    
                    allEmployees[targetIndex].notifications.push({
                        type: 'swap_request',
                        // استخدم اسم المرسل مع اللقب لضمان وضوح الإشعار
                        from: getNameWithPrefix(currentEmpData),
                        message: `طلب تبديل يوم ${request.myDate}`,
                        requestId: request.requestId,
                        timestamp: new Date().toISOString(),
                        read: false
                    });
                }
                
                const saved = await saveDataToFirebase();
                
                if (saved) {
                    console.log('✅ تم حفظ طلب التبديل في Firebase');
                } else {
                    console.log('⚠️ تم حفظ طلب التبديل محلياً فقط');
                }
                // تحديث واجهة الإدارة لعرض الطلب الجديد فوراً
                if (typeof renderAdminSwaps === 'function') {
                    try {
                        renderAdminSwaps();
                    } catch (err) {
                        console.error('تعذر تحديث قائمة التبديلات بعد إضافة الطلب:', err);
                    }
                }
                if (typeof updateStats === 'function') {
                    try {
                        updateStats();
                    } catch (_) {}
                }
                return true;
            } catch (error) {
                console.error('❌ خطأ في إضافة طلب التبديل:', error);
                
                saveToLocalStorage();
                
                return false;
            }
        }

        function requestSwapForDate(date) {
            if(!currentEmpData) {
                Swal.fire({
                    icon: 'warning',
                    title: 'يجب البحث أولاً',
                    text: 'يرجى البحث عن الموظف أولاً لطلب تبديل',
                    confirmButtonText: 'حسناً'
                });
                return;
            }
            
            const myDates = (currentEmpData.schedule || []).filter(s => !s.wasSwappedOut).map(s => s.date);
            
            if(!myDates.includes(date)) {
                Swal.fire({
                    icon: 'error',
                    title: 'غير متاح',
                    text: 'هذا التاريخ غير موجود في جدولك أو غير متاح للتبديل',
                    confirmButtonText: 'حسناً'
                });
                return;
            }
            
            const available = allEmployees.filter(e => 
                e.nationalId !== currentEmpData.nationalId && 
                !(e.schedule || []).some(s => s.date === date && !s.wasSwappedOut)
            );
            
            if(available.length === 0) {
                Swal.fire({
                    icon: 'info',
                    title: 'لا يوجد زملاء متاحين',
                    text: 'لا يوجد زملاء متاحين للتبديل في هذا اليوم',
                    confirmButtonText: 'حسناً'
                });
                return;
            }
            
            Swal.fire({
                title: 'طلب تبديل للتاريخ',
                html: `
                    <div class="text-start">
                        <p>يوم <b>${date}</b> (${getDayAr(date)})</p>
                        <label class="form-label fw-bold">اختر الزميل للتبديل:</label>
                        <select id="swTargetDirect" class="form-select mb-3">
                            ${available.map(e => `<option value="${e.nationalId}">${getNameWithPrefix(e)}</option>`).join('')}
                        </select>
                        <div class="mt-3">
                            <label class="form-label fw-bold">رسالة إضافية (اختياري):</label>
                            <textarea id="swMessageDirect" class="form-control" rows="2" placeholder="أضف رسالة توضيحية..."></textarea>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'إرسال الطلب',
                cancelButtonText: 'إلغاء',
                icon: 'question',
                preConfirm: async () => {
                    const targetId = document.getElementById('swTargetDirect').value;
                    const message = document.getElementById('swMessageDirect').value;
                    
                    const target = allEmployees.find(e => e.nationalId === targetId);
                    if (!target) {
                        Swal.showValidationMessage('الزميل المختار غير موجود');
                        return false;
                    }
                    
                    const requestId = `swap_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    const request = {
                        requestId: requestId,
                        myDate: date,
                        targetId: targetId,
                        // احفظ اسم الهدف باللقب المناسب بحيث يظهر بشكل صحيح في التبديلات
                        targetName: getNameWithPrefix(target),
                        requesterId: currentEmpData.nationalId,
                        requesterName: getNameWithPrefix(currentEmpData),
                        message: message || '',
                        status: 'pending',
                        timestamp: new Date().toISOString()
                    };
                    
                    return await addSwapRequest(request);
                }
            }).then(async result => {
                if(result.isConfirmed) {
                    if (result.value) {
                        Swal.fire({
                            icon: 'success',
                            title: 'تم الإرسال',
                            text: 'تم إرسال طلب التبديل بنجاح',
                            timer: 2000,
                            showConfirmButton: false
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'خطأ',
                            text: 'تعذر إرسال طلب التبديل',
                            timer: 2000,
                            showConfirmButton: false
                        });
                    }
                }
            });
        }

        function downloadSchedule() {
            if(!currentEmpData) {
                Swal.fire({
                    icon: 'warning',
                    title: 'يجب البحث أولاً',
                    text: 'يرجى البحث عن الموظف أولاً',
                    confirmButtonText: 'حسناً'
                });
                return;
            }
            
            const schedule = currentEmpData.schedule || [];
            
            if(schedule.length === 0) {
                Swal.fire({
                    icon: 'info',
                    title: 'لا يوجد جدول',
                    text: 'لا يوجد جدول ملاحظة لحفظه',
                    confirmButtonText: 'حسناً'
                });
                return;
            }
            
            const scheduleHtml = `
                <div class="schedule-for-capture" style="color:#000;">
                    <!-- شعار الكلية والتسمية يظهران في أعلى الجدول ناحية اليسار -->
                    <div style="text-align:left; margin-bottom:20px;">
                        <img src="https://tse2.mm.bing.net/th/id/OIP.yBtj4Qi_E9aiWlLY8KLDGwAAAA?rs=1&amp;pid=ImgDetMain" alt="شعار الكلية" style="height:80px; display:block;">
                        <div style="font-weight:700; margin-top:5px;">كلية الطب البيطري جامعة المنيا</div>
                    </div>
                    <h3 style="text-align: center; margin-bottom: 10px;">جدول ${getNameWithPrefix(currentEmpData)}</h3>
                    <p style="text-align: center; margin-bottom: 20px;">الرقم القومي: ${currentEmpData.nationalId}</p>
                    <table border="1" cellspacing="0" cellpadding="8" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #005f73; color: white;">
                                <th>التاريخ</th>
                                <th>اليوم</th>
                                <th>الحالة</th>
                                <th>التفاصيل</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${schedule.map(s => {
                                const isSwapped = s.isSwapped || s.wasSwappedOut;
                                const statusLabel = isSwapped ? 'تبديل مع' : 'أساسي';
                                const statusColor = isSwapped ? '#0d6efd' : '#198754';
                                // استخدام الاسم مع اللقب إذا وجد الموظف في القائمة
                                let swappedName = '-';
                                if(s.swappedWith) {
                                    const empMatch = allEmployees.find(e => e.name === s.swappedWith);
                                    if(empMatch) {
                                        swappedName = getNameWithPrefix(empMatch);
                                    } else {
                                        swappedName = s.swappedWith;
                                    }
                                }
                                return `
                                <tr ${isSwapped ? 'style="background-color: #e7f1fd;"' : ''}>
                                    <td style="text-align: center;">${s.date}</td>
                                    <td style="text-align: center;">${getDayAr(s.date)}</td>
                                    <td style="text-align: center;">
                                        <span style="background: ${statusColor}; color: white; padding: 3px 8px; border-radius: 4px;">${statusLabel}</span>
                                    </td>
                                    <td style="text-align: center;">${swappedName}</td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                    <p style="text-align: center; margin-top: 20px; font-size: 12px;">
                        تصميم مهندس بولس سمير مدير وحدة تكنولوجيا المعلومات بكلية الطب البيطري جامعة المنيا
                    </p>
                </div>
            `;
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = scheduleHtml;
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            tempDiv.style.top = '0';
            tempDiv.style.width = '800px';
            tempDiv.style.backgroundColor = 'white';
            tempDiv.style.padding = '20px';
            document.body.appendChild(tempDiv);
            
            Swal.fire({
                title: 'جاري التحميل',
                text: 'يرجى الانتظار...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            html2canvas(tempDiv, {
                scale: 2,
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                Swal.close();
                const link = document.createElement('a');
                link.download = `جدول_${currentEmpData.name}_${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                document.body.removeChild(tempDiv);
                
                Swal.fire({
                    icon: 'success',
                    title: 'تم التحميل',
                    text: 'تم حفظ الجدول كصورة بنجاح',
                    timer: 1500,
                    showConfirmButton: false
                });
            }).catch(error => {
                Swal.close();
                document.body.removeChild(tempDiv);
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: 'تعذر حفظ الصورة',
                    confirmButtonText: 'حسناً'
                });
                console.error('خطأ في html2canvas:', error);
            });
        }

        function showAdminLogin() {
            document.getElementById('loginModal').classList.remove('d-none');
            document.getElementById('adminPass').focus();
        }

        function hideLoginModal() {
            document.getElementById('loginModal').classList.add('d-none');
            document.getElementById('adminPass').value = '';
        }

        function checkAdmin() {
            const password = document.getElementById('adminPass').value;
            
            if(password === '85208520') {
                hideLoginModal();
                document.getElementById('userInterface').style.display = 'none';
                document.getElementById('adminDashboardView').style.display = 'block';
                
                const hour = new Date().getHours();
                let greeting = 'مساء الخير';
                if(hour < 12) greeting = 'صباح الخير';
                else if(hour < 18) greeting = 'مساء الخير';
                
                document.getElementById('adminWelcome').innerText = `${greeting}، مدير النظام`;
                
                switchAdminTab('adm1', document.querySelector('.admin-nav-link.active'));
                
                document.getElementById('adminDashboardView').classList.add('animate__fadeIn');

                // إظهار زر تبديل القائمة الجانبية بعد تسجيل الدخول
                const sidebarToggle = document.getElementById('adminSidebarToggle');
                if(sidebarToggle) sidebarToggle.classList.remove('d-none');


                // إخفاء القائمة الجانبية بشكل افتراضي
                const sidebar = document.getElementById('adminSidebar');
                const mainSection = document.getElementById('adminMain');
                const topMenu = document.getElementById('adminTopMenu');
                if(sidebar) {
                    sidebar.classList.add('d-none');
                    sidebar.style.display = 'none';
                }
                // ضبط العرض ليصبح 12 عموداً (عرض كامل) عند إخفاء الشريط الجانبي
                if(mainSection) {
                    mainSection.classList.remove('col-md-10');
                    if(!mainSection.classList.contains('col-md-12')) {
                        mainSection.classList.add('col-md-12');
                    }
                    // إعادة تعيين الهوامش العمودية للقسم الرئيسي
                    mainSection.style.marginTop = '';
                }
                // إخفاء القائمة الأفقية في البداية
                if(topMenu) {
                    topMenu.classList.add('d-none');
                }

                // تحميل وعرض التعليمات في لوحة الإدارة وفي واجهة المستخدم
                if(typeof renderAdminInstructions === 'function') {
                    renderAdminInstructions();
                }
                if(typeof renderUserInstructions === 'function') {
                    renderUserInstructions();
                }
            } else {
                Swal.fire('خطأ', 'كلمة المرور غير صحيحة', 'error');
                document.getElementById('adminPass').value = '';
                document.getElementById('adminPass').focus();
            }
        }

        function logoutAdmin() {
            Swal.fire({
                title: 'تأكيد الخروج',
                text: 'هل أنت متأكد من الخروج من لوحة التحكم؟',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'نعم، خروج',
                cancelButtonText: 'إلغاء'
            }).then(result => {
                if(result.isConfirmed) {
                    document.getElementById('adminDashboardView').style.display = 'none';
                    document.getElementById('userInterface').style.display = 'block';
                    
                    document.getElementById('searchSection').classList.remove('d-none');
                    document.getElementById('empDashboard').classList.add('d-none');
                    
                    document.getElementById('userInterface').classList.add('animate__fadeIn');
                }
            });
        }

        async function addManualEmployee() {
            const name = document.getElementById('aName').value.trim();
            const id = document.getElementById('aId').value.trim();
            
            if(!name || !id) {
                Swal.fire('تنبيه', 'يرجى ملء جميع الحقول', 'warning');
                return;
            }
            
            if(id.length !== 14) {
                Swal.fire('تنبيه', 'الرقم القومي يجب أن يكون 14 رقمًا', 'warning');
                return;
            }
            
            const existing = allEmployees.find(e => e.nationalId === id);
            if(existing) {
                Swal.fire('تنبيه', 'الرقم القومي مسجل مسبقاً', 'warning');
                return;
            }
            
            try {
            const isFaculty = document.getElementById('aIsFaculty')?.checked || false;
            const employeeData = {
                    name: name,
                    nationalId: id,
                    isFaculty: isFaculty,
                    schedule: [],
                    pendingSwaps: [],
                    notifications: [],
                    createdAt: new Date().toISOString(),
                    lastUpdated: new Date().toISOString()
                };
                
                allEmployees.push(employeeData);
                
                const saved = await saveDataToFirebase();
                
                if (saved) {
                    Swal.fire({
                        icon: 'success',
                        title: 'تم الإضافة',
                        text: 'تم إضافة الموظف بنجاح وحفظه في السحابة',
                        timer: 1500,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire({
                        icon: 'success',
                        title: 'تم الإضافة',
                        text: 'تم إضافة الموظف بنجاح (محلياً فقط)',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
                
                document.getElementById('aName').value = '';
                document.getElementById('aId').value = '';
                const facultyCheckbox = document.getElementById('aIsFaculty');
                if (facultyCheckbox) facultyCheckbox.checked = false;
                document.getElementById('aName').focus();
                
                renderAdminEmps();
                updateStats();
                
            } catch (error) {
                console.error('خطأ في إضافة الموظف:', error);
                Swal.fire('خطأ', 'تعذر إضافة الموظف', 'error');
            }
        }

        async function importFromExcel() {
            const fileInput = document.getElementById('excelFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                Swal.fire('تنبيه', 'يرجى اختيار ملف Excel', 'warning');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    console.log('📄 بيانات الملف:', jsonData);
                    
                    if (jsonData.length === 0) {
                        Swal.fire('تنبيه', 'الملف لا يحتوي على بيانات', 'warning');
                        return;
                    }
                    
                    let importedCount = 0;
                    let skippedCount = 0;
                    
                    for (const row of jsonData) {
                        const name = row['الاسم'] || row['اسم'] || row['Name'] || row['name'] || row['الموظف'] || row['EMPLOYEE_NAME'];
                        const nationalId = row['الرقم القومي'] || row['رقم قومي'] || row['National ID'] || row['nationalId'] || row['id'] || row['الرقم'] || row['NATIONAL_ID'];
                        
                        if (!name || !nationalId) {
                            console.warn('❌ صف غير مكتمل:', row);
                            skippedCount++;
                            continue;
                        }
                        
                        const existing = allEmployees.find(e => e.nationalId === nationalId.toString());
                        if (existing) {
                            console.log('⚠️ موجود مسبقاً:', name);
                            skippedCount++;
                            continue;
                        }
                        
                        // استخراج قيمة عمود "عضو هيئة تدريس" أو ما يشبهه من الملف
                        const facultyRaw = row['عضو هيئة تدريس'] ?? row['عضو هئية تدريس'] ?? row['عضو هيئة تدريس؟'] ?? row['Faculty'] ?? row['faculty'] ?? row['isFaculty'] ?? row['IsFaculty'] ?? row['facultyMember'] ?? row['member'] ?? '';
                        let isFacultyFlag = false;
                        if (facultyRaw) {
                            try {
                                const valStr = facultyRaw.toString().trim().toLowerCase();
                                if (valStr === 'نعم' || valStr === 'yes' || valStr === '1' || valStr === 'true' || valStr === 'y' || valStr === 'ن') {
                                    isFacultyFlag = true;
                                } else if (!isNaN(facultyRaw)) {
                                    isFacultyFlag = Number(facultyRaw) !== 0;
                                }
                            } catch (_) {}
                        }
                        const employeeData = {
                            name: name.toString(),
                            nationalId: nationalId.toString(),
                            isFaculty: isFacultyFlag,
                            schedule: [],
                            pendingSwaps: [],
                            notifications: [],
                            createdAt: new Date().toISOString(),
                            lastUpdated: new Date().toISOString()
                        };
                        
                        try {
                            allEmployees.push(employeeData);
                            importedCount++;
                            console.log('✅ تم إضافة:', name);
                        } catch (error) {
                            console.error('❌ خطأ في إضافة:', name, error);
                            skippedCount++;
                        }
                    }
                    
                    const saved = await saveDataToFirebase();
                    
                    if (saved) {
                        Swal.fire({
                            icon: 'success',
                            title: 'تم الاستيراد',
                            html: `تم استيراد <b>${importedCount}</b> موظف بنجاح وحفظهم في السحابة<br>
                                   تم تخطي <b>${skippedCount}</b> موظف (موجودين مسبقاً أو بيانات غير مكتملة)`,
                            timer: 3000,
                            showConfirmButton: false
                        });
                    } else {
                        Swal.fire({
                            icon: 'success',
                            title: 'تم الاستيراد',
                            html: `تم استيراد <b>${importedCount}</b> موظف بنجاح (محلياً فقط)<br>
                                   تم تخطي <b>${skippedCount}</b> موظف (موجودين مسبقاً أو بيانات غير مكتملة)`,
                            timer: 3000,
                            showConfirmButton: false
                        });
                    }
                    
                    fileInput.value = '';
                    
                    renderAdminEmps();
                    updateStats();
                    
                } catch (error) {
                    console.error('❌ خطأ في قراءة الملف:', error);
                    Swal.fire('خطأ', 'تعذر قراءة ملف Excel', 'error');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function renderAdminEmps() {
            const container = document.getElementById('adminEmpsList');
            
            if(!allEmployees || allEmployees.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-users fa-2x mb-3"></i>
                        <p>لا يوجد موظفين مسجلين</p>
                        <button class="btn btn-sm btn-primary mt-2" onclick="importFromExcel()">
                            <i class="fas fa-file-excel me-1"></i>استيراد من Excel
                        </button>
                    </div>`;
                document.getElementById('empCount').innerText = '0 موظف';
                return;
            }
            
            let html = '';
            allEmployees.forEach((emp, index) => {
                const scheduleCount = emp.schedule ? emp.schedule.length : 0;
                const pendingSwapsCount = emp.pendingSwaps ? emp.pendingSwaps.filter(s => s.status === 'pending').length : 0;
                
                html += `
                    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center animate__animated animate__fadeInUp" 
                         style="animation-delay: ${index * 0.05}s">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                     style="width: 40px; height: 40px;">
                                    ${emp.name.split(' ').map(n => n[0]).join('').toUpperCase() || '??'}
                                </div>
                            </div>
                            <div>
                                <h6 class="mb-1 fw-bold">${getNameWithPrefix(emp)}</h6>
                                <small class="text-muted">${emp.nationalId}</small>
                                <div class="mt-1">
                                    ${emp.isFaculty ? `<span class="badge bg-info me-1">عضو هيئة تدريس</span>` : ''}
                                    <span class="badge bg-success me-1">${scheduleCount} يوم</span>
                                    ${pendingSwapsCount > 0 ? 
                                        `<span class="badge bg-warning">${pendingSwapsCount} طلب</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="openAssignModal('${emp.nationalId}')">
                                <i class="fas fa-calendar-plus"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="editEmp('${emp.nationalId}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info" onclick="showEmpDetailsAdmin('${emp.nationalId}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteEmp('${emp.nationalId}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>`;
            });
            
            container.innerHTML = html;
            document.getElementById('empCount').innerText = `${allEmployees.length} موظف`;
        }

        function showEmpDetailsAdmin(empId) {
            const emp = allEmployees.find(e => e.nationalId === empId);
            if(!emp) return;
            
            const scheduleCount = emp.schedule ? emp.schedule.length : 0;
            const pendingSwapsCount = emp.pendingSwaps ? emp.pendingSwaps.filter(s => s.status === 'pending').length : 0;
            const completedSwapsCount = emp.pendingSwaps ? emp.pendingSwaps.filter(s => s.status === 'completed').length : 0;
            
            let scheduleHtml = '';
            if(scheduleCount > 0) {
                scheduleHtml = '<ul class="list-group list-group-flush">';
                emp.schedule.forEach(s => {
                    scheduleHtml += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                ${s.date} (${getDayAr(s.date)})
                                ${s.isSwapped ? `<span class="badge bg-primary ms-2">تبديل مع</span>` : ''}
                                ${s.wasSwappedOut ? `<span class="badge bg-primary ms-2">تبديل مع</span>` : ''}
                            </div>
                            ${s.swappedWith ? `<small class="text-muted">مع ${s.swappedWith}</small>` : ''}
                        </li>`;
                });
                scheduleHtml += '</ul>';
            }
            
            Swal.fire({
                title: emp.name,
                html: `
                    <div class="text-start">
                        <div class="row mb-3">
                            <div class="col-6">
                                <div class="p-3 bg-light rounded">
                                    <h6 class="fw-bold">الرقم القومي</h6>
                                    <p class="mb-0">${emp.nationalId}</p>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-3 bg-light rounded">
                                    <h6 class="fw-bold">تاريخ التسجيل</h6>
                                    <p class="mb-0">${emp.createdAt ? new Date(emp.createdAt).toLocaleDateString('ar-EG') : 'غير معروف'}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-4 text-center">
                                <div class="p-2 bg-primary bg-opacity-10 rounded">
                                    <h3 class="text-primary">${scheduleCount}</h3>
                                    <!-- عرض عدد أيام الملاحظات بدلاً من أيام العمل بناءً على طلب المستخدم -->
                                    <small>عدد أيام الملاحظات</small>
                                </div>
                            </div>
                            <div class="col-4 text-center">
                                <div class="p-2 bg-warning bg-opacity-10 rounded">
                                    <h3 class="text-warning">${pendingSwapsCount}</h3>
                                    <small>طلبات معلقة</small>
                                </div>
                            </div>
                            <div class="col-4 text-center">
                                <div class="p-2 bg-success bg-opacity-10 rounded">
                                    <h3 class="text-success">${completedSwapsCount}</h3>
                                    <small>تبديلات مكتملة</small>
                                </div>
                            </div>
                        </div>
                        
                        ${scheduleCount > 0 ? `
                        <div class="mb-3">
                            <h6 class="fw-bold">جدول الملاحظات</h6>
                            ${scheduleHtml}
                        </div>` : ''}
                    </div>
                `,
                width: 600,
                showConfirmButton: false,
                showCloseButton: true
            });
        }

        async function deleteEmp(empId) {
            Swal.fire({
                title: 'تأكيد الحذف',
                text: 'هل أنت متأكد من حذف هذا الموظف؟ لا يمكن التراجع عن هذا الإجراء.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، احذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#dc3545'
            }).then(async result => {
                if (result.isConfirmed) {
                    try {
                        // إزالة الموظف من المصفوفة المحلية
                        allEmployees = allEmployees.filter(e => e.nationalId !== empId);
                        // حفظ التغييرات محلياً
                        saveToLocalStorage();
                        // تحديث الواجهات والإحصائيات
                        renderAdminEmps();
                        updateStats();
                        // إذا كان Firebase مهيئاً، قم بحذف وثيقة الموظف من المجموعة مباشرة
                        let remoteDeleted = false;
                        if (firebaseInitialized && typeof db !== 'undefined') {
                            try {
                                await db.collection('employees').doc(empId).delete();
                                remoteDeleted = true;
                            } catch (err) {
                                console.warn('⚠️ تعذر حذف الموظف من Firebase مباشرة:', err);
                            }
                        }
                        // ثم احفظ باقي البيانات المحدثة في Firebase لخلق التزامن
                        const saved = await saveDataToFirebase();
                        if (remoteDeleted && saved) {
                            Swal.fire({ icon:'success', title:'تم الحذف', text:'تم حذف الموظف بنجاح من السحابة والمحفوظات المحلية', timer:1500, showConfirmButton:false });
                        } else if (saved) {
                            Swal.fire({ icon:'success', title:'تم الحذف', text:'تم حذف الموظف من المحفوظات المحلية وتحديث السحابة', timer:1500, showConfirmButton:false });
                        } else {
                            Swal.fire({ icon:'success', title:'تم الحذف', text:'تم حذف الموظف من المحفوظات المحلية فقط', timer:1500, showConfirmButton:false });
                        }
                    } catch (error) {
                        console.error('خطأ في الحذف:', error);
                        Swal.fire('خطأ', 'تعذر حذف الموظف', 'error');
                    }
                }
            });
        }

        /**
         * تعديل بيانات موظف موجود. يتيح للمسؤول تعديل اسم الموظف وكونه
         * عضو هيئة تدريس أو لا. بعد حفظ التغييرات يتم تحديث قائمة الموظفين،
         * التبديلات اليدوية، والجداول المرتبطة.
         *
         * @param {string} empId الرقم القومي للموظف
         */
        function editEmp(empId) {
            const emp = allEmployees.find(e => e.nationalId === empId);
            if (!emp) return;
            Swal.fire({
                title: 'تعديل بيانات الموظف',
                html: `
                    <div class="text-start">
                        <div class="mb-3">
                            <label class="form-label">الاسم</label>
                            <input type="text" id="editEmpName" class="form-control" value="${emp.name}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">الرقم القومي</label>
                            <input type="text" id="editEmpId" class="form-control" value="${emp.nationalId}">
                        </div>
                        <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input" id="editEmpFaculty" ${emp.isFaculty ? 'checked' : ''}>
                            <label class="form-check-label" for="editEmpFaculty">عضو هيئة تدريس</label>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'حفظ',
                cancelButtonText: 'إلغاء',
                preConfirm: () => {
                    const newName = document.getElementById('editEmpName').value.trim();
                    const newId = document.getElementById('editEmpId').value.trim();
                    const newIsFaculty = document.getElementById('editEmpFaculty').checked;
                    if (!newName) {
                        Swal.showValidationMessage('يرجى إدخال الاسم');
                        return false;
                    }
                    // التحقق من الرقم القومي
                    if (!newId || newId.length !== 14 || !/^\d{14}$/.test(newId)) {
                        Swal.showValidationMessage('يرجى إدخال رقم قومي صحيح مكون من 14 رقماً');
                        return false;
                    }
                    // التأكد من عدم تكرار الرقم القومي عند تغييره
                    if (newId !== emp.nationalId && allEmployees.some(e => e.nationalId === newId)) {
                        Swal.showValidationMessage('الرقم القومي مسجل مسبقاً');
                        return false;
                    }
                    return { newName, newId, newIsFaculty };
                }
            }).then(result => {
                if (result.isConfirmed) {
                    const { newName, newId, newIsFaculty } = result.value;
                    const oldId = emp.nationalId;
                    // تحديث بيانات الموظف
                    emp.name = newName;
                    emp.isFaculty = newIsFaculty;
                    emp.nationalId = newId;
                    // تحديث بيانات التبديلات اليدوية: تحديث المعرفات والأسماء
                    (manualSwaps || []).forEach(swap => {
                        if (swap.emp1Id === oldId) {
                            swap.emp1Id = newId;
                            swap.emp1Name = getNameWithPrefix(emp);
                        }
                        if (swap.emp2Id === oldId) {
                            swap.emp2Id = newId;
                            swap.emp2Name = getNameWithPrefix(emp);
                        }
                    });
                    // تحديث schedule: تحديث حقل swappedFrom في جميع الموظفين
                    (allEmployees || []).forEach(e => {
                        if (e.schedule && Array.isArray(e.schedule)) {
                            e.schedule = e.schedule.map(a => {
                                if (a.swappedFrom === oldId) {
                                    return { ...a, swappedFrom: newId };
                                }
                                return a;
                            });
                        }
                    });
                    // تحديث الطلبات المعلقة pendingSwaps: تعديل requesterId أو targetId
                    (allEmployees || []).forEach(e => {
                        if (e.pendingSwaps && Array.isArray(e.pendingSwaps)) {
                            e.pendingSwaps.forEach(p => {
                                if (p.requesterId === oldId) {
                                    p.requesterId = newId;
                                    // تحديث الاسم إذا كان هذا الموظف هو المرسل
                                    p.requesterName = getNameWithPrefix(emp);
                                }
                                if (p.targetId === oldId) {
                                    p.targetId = newId;
                                    p.targetName = getNameWithPrefix(emp);
                                }
                            });
                        }
                    });
                    // تحديث بيانات currentEmpData إذا كانت هي نفس الموظف
                    if (typeof currentEmpData !== 'undefined' && currentEmpData && currentEmpData.nationalId === oldId) {
                        currentEmpData.name = newName;
                        currentEmpData.isFaculty = newIsFaculty;
                        currentEmpData.nationalId = newId;
                    }
                    // حفظ التغييرات
                    saveManualSwaps(manualSwaps);
                    saveDataToFirebase();
                    // تحديث الواجهات
                    renderAdminEmps();
                    updateStats();
                    if (typeof renderMasterReport === 'function') {
                        try { renderMasterReport(); } catch (_) {}
                    }
                    if (typeof renderAssignmentOverview === 'function') {
                        try { renderAssignmentOverview(); } catch (_) {}
                    }
                    Swal.fire({
                        icon: 'success',
                        title: 'تم التعديل',
                        text: 'تم تعديل بيانات الموظف بنجاح',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
            });
        }

        // اجعل الدالة متاحة من خلال الكائن window حتى تعمل خاصية onclick
        if (typeof window !== 'undefined') {
            window.editEmp = editEmp;
        }

        async function addDate() {
            const dateInput = document.getElementById('newDate');
            const date = dateInput.value;
            
            if(!date) {
                Swal.fire('تنبيه', 'يرجى اختيار تاريخ', 'warning');
                return;
            }
            
            if(allDates.includes(date)) {
                Swal.fire('تنبيه', 'هذا التاريخ مضاف مسبقاً', 'warning');
                return;
            }
            
            try {
                allDates.push(date);
                allDates.sort();
                
                const saved = await saveDataToFirebase();
                
                if (saved) {
                    Swal.fire({
                        icon: 'success',
                        title: 'تم الإضافة',
                        text: 'تم إضافة التاريخ بنجاح وحفظه في السحابة',
                        timer: 1500,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire({
                        icon: 'success',
                        title: 'تم الإضافة',
                        text: 'تم إضافة التاريخ بنجاح (محلياً فقط)',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
                
                dateInput.value = '';
                renderAdminDates();
                
            } catch (error) {
                console.error('خطأ في إضافة التاريخ:', error);
                Swal.fire('خطأ', 'تعذر إضافة التاريخ', 'error');
            }
        }

        async function addMultipleDates() {
            Swal.fire({
                title: 'إضافة نطاق تواريخ',
                html: `
                    <div class="text-start">
                        <div class="mb-3">
                            <label class="form-label">من تاريخ</label>
                            <input type="date" id="dateFrom" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">إلى تاريخ</label>
                            <input type="date" id="dateTo" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">استثناء أيام</label>
                            <select id="excludeDays" class="form-select" multiple>
                                <option value="0">الأحد</option>
                                <option value="1">الإثنين</option>
                                <option value="2">الثلاثاء</option>
                                <option value="3">الأربعاء</option>
                                <option value="4">الخميس</option>
                                <option value="5">الجمعة</option>
                                <option value="6">السبت</option>
                            </select>
                            <small class="text-muted">اضغط Ctrl لاختيار أكثر من يوم</small>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'إضافة',
                preConfirm: () => {
                    const from = document.getElementById('dateFrom').value;
                    const to = document.getElementById('dateTo').value;
                    const excludeDays = Array.from(document.getElementById('excludeDays').selectedOptions)
                        .map(opt => parseInt(opt.value));
                    
                    if(!from || !to) {
                        Swal.showValidationMessage('يرجى تعبئة جميع الحقول');
                        return false;
                    }
                    
                    const fromDate = new Date(from);
                    const toDate = new Date(to);
                    
                    if(fromDate > toDate) {
                        Swal.showValidationMessage('تاريخ البداية يجب أن يكون قبل تاريخ النهاية');
                        return false;
                    }
                    
                    const datesToAdd = [];
                    const currentDate = new Date(fromDate);
                    
                    while(currentDate <= toDate) {
                        const dateStr = currentDate.toISOString().split('T')[0];
                        const dayOfWeek = currentDate.getDay();
                        
                        if(!excludeDays.includes(dayOfWeek) && !allDates.includes(dateStr)) {
                            datesToAdd.push(dateStr);
                        }
                        
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                    
                    if(datesToAdd.length === 0) {
                        Swal.showValidationMessage('لا توجد تواريخ جديدة لإضافتها');
                        return false;
                    }
                    
                    return datesToAdd;
                }
            }).then(async result => {
                if(result.isConfirmed && result.value) {
                    try {
                        const newDates = [...allDates, ...result.value];
                        newDates.sort();
                        
                        allDates = newDates;
                        
                        const saved = await saveDataToFirebase();
                        
                        if (saved) {
                            Swal.fire({
                                icon: 'success',
                                title: 'تم الإضافة',
                                text: `تم إضافة ${result.value.length} تاريخ جديد وحفظهم في السحابة`,
                                timer: 2000,
                                showConfirmButton: false
                            });
                        } else {
                            Swal.fire({
                                icon: 'success',
                                title: 'تم الإضافة',
                                text: `تم إضافة ${result.value.length} تاريخ جديد (محلياً فقط)`,
                                timer: 2000,
                                showConfirmButton: false
                            });
                        }
                        
                        renderAdminDates();
                        
                    } catch (error) {
                        console.error('خطأ في إضافة التواريخ:', error);
                        Swal.fire('خطأ', 'تعذر إضافة التواريخ', 'error');
                    }
                }
            });
        }

        function renderAdminDates() {
            const container = document.getElementById('adminDatesList');
            
            if(!allDates || allDates.length === 0) {
                container.innerHTML = `
                    <div class="text-center w-100 py-3 text-muted">
                        <i class="fas fa-calendar-times fa-2x mb-2"></i>
                        <p class="mb-0">لم يتم إضافة أي تواريخ</p>
                    </div>`;
                return;
            }
            
            let html = '';
            allDates.forEach(date => {
                html += `
                    <div class="badge bg-secondary p-2 d-flex align-items-center animate__animated animate__fadeIn">
                        <span>${date} (${getDayAr(date).substr(0, 3)})</span>
                        <button type="button" class="btn btn-sm btn-outline-light ms-2" onclick="deleteDate('${date}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>`;
            });
            
            container.innerHTML = html;
        }

        async function deleteDate(date) {
            Swal.fire({
                title: 'تأكيد الحذف',
                text: `هل أنت متأكد من حذف تاريخ ${date}؟`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'نعم، احذف',
                cancelButtonText: 'إلغاء'
            }).then(async result => {
                if(result.isConfirmed) {
                    try {
                        const newDates = allDates.filter(d => d !== date);
                        allDates = newDates;
                        
                        const saved = await saveDataToFirebase();
                        
                        if (saved) {
                            Swal.fire({
                                icon: 'success',
                                title: 'تم الحذف',
                                text: 'تم حذف التاريخ بنجاح من السحابة والمحفوظات المحلية',
                                timer: 1500,
                                showConfirmButton: false
                            });
                        } else {
                            Swal.fire({
                                icon: 'success',
                                title: 'تم الحذف',
                                text: 'تم حذف التاريخ من المحفوظات المحلية فقط',
                                timer: 1500,
                                showConfirmButton: false
                            });
                        }
                        
                        renderAdminDates();
                        
                    } catch (error) {
                        console.error('خطأ في حذف التاريخ:', error);
                        Swal.fire('خطأ', 'تعذر حذف التاريخ', 'error');
                    }
                }
            });
        }

        function filterAssignSearch() {
            const query = document.getElementById('assignSearch').value.toLowerCase().trim();
            const container = document.getElementById('assignSearchResults');
            
            if(!query) {
                container.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-search fa-2x mb-3"></i>
                        <p>ابدأ الكتابة للبحث عن موظف</p>
                    </div>`;
                return;
            }
            
            const results = allEmployees.filter(emp => 
                (emp.name && emp.name.toLowerCase().includes(query)) || 
                (emp.nationalId && emp.nationalId.includes(query))
            );
            
            if(results.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-user-slash fa-2x mb-3"></i>
                        <p>لا توجد نتائج للبحث</p>
                    </div>`;
                return;
            }
            
            let html = '';
            results.forEach(emp => {
                const scheduleCount = emp.schedule ? emp.schedule.length : 0;
                
                html += `
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" 
                            onclick="openAssignModal('${emp.nationalId}')">
                        <div>
                            <h6 class="mb-1 fw-bold">${emp.name}</h6>
                            <small class="text-muted">${emp.nationalId}</small>
                        </div>
                        <div>
                            <span class="badge ${scheduleCount > 0 ? 'bg-success' : 'bg-secondary'}">
                                ${scheduleCount} يوم
                            </span>
                        </div>
                    </button>`;
            });
            
            container.innerHTML = html;
        }

        function openAssignModal(empId) {
            const emp = allEmployees.find(e => e.nationalId === empId);
            if(!emp) return;
            
            const currentDates = (emp.schedule || []).map(s => s.date);
            
            let datesHtml = '';
            if(allDates.length > 0) {
                allDates.forEach(date => {
                    const isChecked = currentDates.includes(date);
                    datesHtml += `
                        <div class="col-md-4 col-sm-6 mb-2">
                            <div class="form-check">
                                <input class="form-check-input assign-date-cb" type="checkbox" 
                                       value="${date}" id="assign_${date}" ${isChecked ? 'checked' : ''}>
                                <label class="form-check-label" for="assign_${date}">
                                    ${date} (${getDayAr(date)})
                                </label>
                            </div>
                        </div>`;
                });
            } else {
                datesHtml = `
                    <div class="col-12 text-center py-4 text-muted">
                        <i class="fas fa-calendar-times fa-2x mb-3"></i>
                        <p>لم يتم إضافة أي تواريخ امتحانات</p>
                        <p class="small">يجب إضافة تواريخ أولاً من قسم "التوزيع"</p>
                    </div>`;
            }
            
            Swal.fire({
                title: `توزيع جدول ${emp.name}`,
                html: `
                    <div class="text-start">
                        <div class="mb-3">
                            <p class="mb-1"><b>الرقم القومي:</b> ${emp.nationalId}</p>
                            <p class="mb-3"><b>الأيام الحالية:</b> ${currentDates.length} يوم</p>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="fw-bold m-0">تواريخ الامتحانات</h6>
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="selectAllDates()">تحديد الكل</button>
                                    <button class="btn btn-sm btn-outline-secondary ms-1" onclick="deselectAllDates()">إلغاء الكل</button>
                                </div>
                            </div>
                            <div class="row mt-2" style="max-height: 300px; overflow-y: auto;">
                                ${datesHtml}
                            </div>
                        </div>
                    </div>
                `,
                width: 700,
                showCancelButton: true,
                confirmButtonText: 'حفظ التوزيع',
                cancelButtonText: 'إلغاء',
                didOpen: () => {
                    window.selectAllDates = () => {
                        document.querySelectorAll('.assign-date-cb').forEach(cb => {
                            cb.checked = true;
                        });
                    };

                    window.deselectAllDates = () => {
                        document.querySelectorAll('.assign-date-cb').forEach(cb => {
                            cb.checked = false;
                        });
                    };

                    const confirmBtn = Swal.getConfirmButton();
                    if (confirmBtn) {
                        confirmBtn.addEventListener('click', async (e) => {
                            e.preventDefault();
                            confirmBtn.disabled = true;

                            const selectedDates = Array.from(document.querySelectorAll('.assign-date-cb:checked'))
                                .map(cb => ({
                                    date: cb.value,
                                    isSwapped: false,
                                    wasSwappedOut: false,
                                    swappedWith: null
                                }));

                            const empIndex = allEmployees.findIndex(e => e.nationalId === empId);
                            if (empIndex !== -1) {
                                allEmployees[empIndex].schedule = selectedDates;
                                allEmployees[empIndex].lastUpdated = new Date().toISOString();

                                if (currentEmpData && currentEmpData.nationalId === empId) {
                                    currentEmpData.schedule = selectedDates;
                                }
                            }

                            let savedToCloud = false;
                            try {
                                savedToCloud = await saveDataToFirebase();
                            } catch (err) {
                                console.error('خطأ أثناء حفظ التوزيع:', err);
                            }

                            Swal.close();

                            const successText = savedToCloud ?
                                'تم تحديث جدول الموظف بنجاح وحفظه في السحابة' :
                                'تم تحديث جدول الموظف بنجاح (محلياً فقط)';
                            Swal.fire({
                                icon: 'success',
                                title: 'تم التوزيع',
                                text: successText,
                                timer: 1500,
                                showConfirmButton: false
                            });

                            if (typeof renderAdminEmps === 'function') {
                                renderAdminEmps();
                            }
                            if (currentEmpData && currentEmpData.nationalId === empId && typeof renderEmpUI === 'function') {
                                renderEmpUI();
                            }
                            if (typeof filterAssignSearch === 'function') {
                                setTimeout(() => {
                                    try {
                                        filterAssignSearch();
                                    } catch (_) {}
                                    const assignInput = document.getElementById('assignSearch');
                                    if (assignInput) {
                                        assignInput.dispatchEvent(new KeyboardEvent('keyup'));
                                    }
                                }, 50);
                            }
                        }, { once: true });
                    }
                }
            });
        }

        function renderMasterReport() {
            const container = document.getElementById('masterReportArea');
            
            if(allEmployees.length === 0 || allDates.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-file-alt fa-3x mb-3"></i>
                        <h5>لا توجد بيانات لعرضها</h5>
                        <p>يجب إضافة موظفين وتواريخ أولاً</p>
                    </div>`;
                return;
            }
            
            let html = `
                <div style="overflow-x: auto;">
                    <table class="table table-bordered table-sm text-center align-middle" style="min-width: 800px; font-size: 12px;">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 200px; font-size: 11px;" class="text-start">اسم الموظف</th>
                                ${allDates.map(date => `
                                    <!-- عرض اليوم بالكامل بدلاً من أول ثلاثة أحرف للتوضيح -->
                                    <th style="font-size: 11px; min-width: 70px;">${date}<br><small>${getDayAr(date)}</small></th>
                                `).join('')}
                                <th style="font-size: 11px;">الإجمالي</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            allEmployees.forEach(emp => {
                const schedule = emp.schedule || [];
                let totalDays = 0;
                
                html += `<tr>
                    <td class="text-start fw-bold" style="font-size: 11px;">${getNameWithPrefix(emp)}</td>`;
                
                allDates.forEach(date => {
                    const assignment = schedule.find(s => s.date === date);
                    if(!assignment) {
                        html += `<td class="bg-light"></td>`;
                    } else if(assignment.wasSwappedOut || assignment.isSwapped) {
                        // عند وجود تبديل، أظهر اسم الزميل في الخلية بالإضافة إلى وصف التبديل
                        let swapName = assignment.swappedWith || '';
                        if (swapName) {
                            const matchEmp = allEmployees.find(e => e.name === swapName);
                            if (matchEmp) {
                                swapName = getNameWithPrefix(matchEmp);
                            }
                        } else {
                            swapName = 'غير معروف';
                        }
                        html += `<td class="bg-primary bg-opacity-25" style="font-size: 10px; line-height:1.2;" title="تبديل مع ${swapName}">
                            <i class="fas fa-exchange-alt text-primary me-1"></i> تبديل مع<br><small style="font-size: 9px;">${swapName}</small>
                        </td>`;
                        totalDays++;
                    } else {
                        html += `<td class="bg-success bg-opacity-50">
                            <i class="fas fa-check text-success"></i>
                        </td>`;
                        totalDays++;
                    }
                });
                
                html += `<td class="fw-bold" style="font-size: 11px;">${totalDays}</td></tr>`;
            });
            
            html += `<tr class="table-info">
                <td class="text-start fw-bold" style="font-size: 11px;">الإجمالي</td>`;
            
            allDates.forEach(date => {
                const count = allEmployees.filter(emp => 
                    (emp.schedule || []).some(s => s.date === date && !s.wasSwappedOut)
                ).length;
                html += `<td class="fw-bold" style="font-size: 11px;">${count}</td>`;
            });
            
            html += `<td class="fw-bold" style="font-size: 11px;">${allEmployees.reduce((sum, emp) => 
                sum + (emp.schedule || []).filter(s => !s.wasSwappedOut).length, 0)}</td>
            </tr>`;
            
            html += `</tbody></table></div>`;
            
            container.innerHTML = html;
        }

        function exportMasterReport() {
            if(allEmployees.length === 0 || allDates.length === 0) {
                Swal.fire('تنبيه', 'لا توجد بيانات للتصدير', 'info');
                return;
            }
            
            const data = [];
            
            data.push(['الجدول العام للمراقبة - ' + new Date().toLocaleDateString('ar-EG')]);
            data.push([]);
            
            const headers = ['اسم الموظف', ...allDates, 'الإجمالي'];
            data.push(headers);
            
            allEmployees.forEach(emp => {
                const schedule = emp.schedule || [];
                let totalDays = 0;
                
                const row = [emp.name];
                
                allDates.forEach(date => {
                    const assignment = schedule.find(s => s.date === date);
                    
                    if(!assignment) {
                        row.push('');
                    } else if(assignment.wasSwappedOut) {
                        row.push(`تبديل مع ${assignment.swappedWith || 'غير معروف'}`);
                    } else if(assignment.isSwapped) {
                        row.push(`بدل من ${assignment.swappedWith || 'غير معروف'}`);
                        totalDays++;
                    } else {
                        row.push('أساسي');
                        totalDays++;
                    }
                });
                
                row.push(totalDays);
                data.push(row);
            });
            
            const totalRow = ['الإجمالي'];
            allDates.forEach(date => {
                const count = allEmployees.filter(emp => 
                    (emp.schedule || []).some(s => s.date === date && !s.wasSwappedOut)
                ).length;
                totalRow.push(count);
            });
            totalRow.push(allEmployees.reduce((sum, emp) => 
                sum + (emp.schedule || []).filter(s => !s.wasSwappedOut).length, 0));
            data.push(totalRow);
            
            try {
                const ws = XLSX.utils.aoa_to_sheet(data);
                
                const wscols = [
                    { wch: 25 },
                    ...allDates.map(() => ({ wch: 12 })),
                    { wch: 8 }
                ];
                ws['!cols'] = wscols;
                
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'الجدول العام');
                
                const fileName = `الجدول_العام_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                Swal.fire({
                    icon: 'success',
                    title: 'تم التصدير',
                    text: 'تم حفظ الملف بنجاح',
                    timer: 1500,
                    showConfirmButton: false
                });
            } catch (error) {
                console.error('خطأ في التصدير:', error);
                Swal.fire('خطأ', 'تعذر تصدير الملف', 'error');
            }
        }

        // دالة لتوليد جدول التوزيع المباشر في تبويب التوزيع
        function renderAssignmentOverview() {
            const container = document.getElementById('assignmentOverview');
            if (!container) return;

            // إذا لم يوجد موظفون أو تواريخ، اعرض رسالة فارغة
            if (!allEmployees || allEmployees.length === 0 || !allDates || allDates.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-3 text-muted">
                        <i class="fas fa-table fa-2x mb-2"></i>
                        <p class="mb-0">لا يوجد بيانات لعرضها</p>
                    </div>`;
                return;
            }

            // بناء الجدول
            let html = `
                <div style="overflow-x:auto;">
                    <table class="table table-bordered table-sm text-center align-middle">
                        <thead class="table-secondary">
                            <tr>
                                <th class="text-start">اسم الموظف</th>`;
            allDates.forEach(date => {
                // إظهار اليوم بالكامل بدلاً من أول ثلاثة أحرف
                html += `<th>${date}<br><small>${getDayAr(date)}</small></th>`;
            });
            html += `<th>الإجمالي</th></tr></thead><tbody>`;

            allEmployees.forEach(emp => {
                const schedule = emp.schedule || [];
                let total = 0;
                html += `<tr><td class="text-start">${getNameWithPrefix(emp)}</td>`;
                allDates.forEach(date => {
                    const assignment = schedule.find(s => s.date === date);
                    if (!assignment) {
                        html += `<td></td>`;
                    } else if (assignment.wasSwappedOut || assignment.isSwapped) {
                        // عرض اسم الزميل الذي تم التبديل معه
                        let swapName = assignment.swappedWith || '';
                        if (swapName) {
                            const match = allEmployees.find(e => e.name === swapName);
                            if (match) {
                                swapName = getNameWithPrefix(match);
                            }
                        } else {
                            swapName = 'غير معروف';
                        }
                        html += `<td style="font-size: 11px;"><i class="fas fa-exchange-alt text-primary me-1"></i> تبديل مع<br><small style="font-size: 10px;">${swapName}</small></td>`;
                        total++;
                    } else {
                        html += `<td><i class="fas fa-check text-success me-1"></i> أساسي</td>`;
                        total++;
                    }
                });
                html += `<td>${total}</td></tr>`;
            });
            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }

        function updateStats() {
            let pendingSwaps = 0;
            let completedSwaps = 0;
            
            allEmployees.forEach(emp => {
                (emp.pendingSwaps || []).forEach(swap => {
                    if(swap.status === 'pending') pendingSwaps++;
                    else if(swap.status === 'completed') completedSwaps++;
                });
            });
            
                if (document.getElementById('statsSummary')) {
                    // قم بتجميع عناصر النظرة العامة بطريقة تجعل صفوف الطلبات والتبديلات قابلة للنقر بأكملها،
                    // وذلك لتحسين تجربة المستخدم وتسهيل فتح تفاصيل التبديلات من أي موضع في الصف.
                    let summaryHtml = `
                        <div class="mb-3">
                            <h6 class="fw-bold">نظرة عامة</h6>
                            <div class="row mt-3">
                                <div class="col-6 mb-2">
                                    <div class="d-flex justify-content-between">
                                        <span>إجمالي الموظفين:</span>
                                        <span class="fw-bold text-primary" style="cursor:pointer;" onclick="window.showEmployeeList()">${allEmployees.length}</span>
                                    </div>
                                </div>
                                <div class="col-6 mb-2">
                                    <div class="d-flex justify-content-between">
                                        <span>أيام الامتحانات:</span>
                                        <span class="fw-bold">${allDates.length}</span>
                                    </div>
                                </div>
                                <div class="col-6 mb-2">
                                    <div class="d-flex justify-content-between" onclick="window.showSwapOverview()" style="cursor:pointer;">
                                        <span>طلبات التبديل:</span>
                                        <span class="fw-bold text-primary">${pendingSwaps}</span>
                                    </div>
                                </div>
                                <div class="col-6 mb-2">
                                    <div class="d-flex justify-content-between" onclick="window.showSwapOverview()" style="cursor:pointer;">
                                        <span>تبديلات مكتملة:</span>
                                        <span class="fw-bold text-primary">${completedSwaps}</span>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    document.getElementById('statsSummary').innerHTML = summaryHtml;
                }
            
            updateStatsChart();

            // تحديث جدول التوزيع مباشرة بعد تحديث الإحصائيات
            if (typeof renderAssignmentOverview === 'function') {
                try {
                    renderAssignmentOverview();
                } catch (err) {
                    console.error('تعذر تحديث جدول التوزيع:', err);
                }
            }
        }

        function updateStatsChart() {
            const ctx = document.getElementById('statsChart');
            if(!ctx) return;
            
            let pendingByDate = {};
            let completedByDate = {};
            
            allEmployees.forEach(emp => {
                (emp.pendingSwaps || []).forEach(swap => {
                    if(swap.status === 'pending') {
                        pendingByDate[swap.myDate] = (pendingByDate[swap.myDate] || 0) + 1;
                    } else if(swap.status === 'completed') {
                        completedByDate[swap.myDate] = (completedByDate[swap.myDate] || 0) + 1;
                    }
                });
            });
            
            const labels = allDates.slice(-7);
            const pendingData = labels.map(date => pendingByDate[date] || 0);
            const completedData = labels.map(date => completedByDate[date] || 0);
            
            if(statsChart) {
                statsChart.data.labels = labels;
                statsChart.data.datasets[0].data = pendingData;
                statsChart.data.datasets[1].data = completedData;
                statsChart.update();
            } else {
                statsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'طلبات معلقة',
                                data: pendingData,
                                backgroundColor: 'rgba(255, 193, 7, 0.7)',
                                borderColor: 'rgb(255, 193, 7)',
                                borderWidth: 1
                            },
                            {
                                label: 'مكتملة',
                                data: completedData,
                                backgroundColor: 'rgba(25, 135, 84, 0.7)',
                                borderColor: 'rgb(25, 135, 84)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                                rtl: true
                            },
                            title: {
                                display: true,
                                text: 'طلبات التبديل في آخر 7 أيام'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            }
        }

        function switchAdminTab(tabId, element) {
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.add('d-none');
            });
            
            // احصل على العنصر الخاص بالتبويب المطلوب
            const tabElement = document.getElementById(tabId);
            if (tabElement) {
                // إذا كانت هذه التبويبة خارج حاوية adminContent قم بنقلها داخل الحاوية لضمان ظهورها في المكان الصحيح
                const adminContent = document.getElementById('adminContent');
                if (adminContent && !adminContent.contains(tabElement)) {
                    adminContent.appendChild(tabElement);
                }
                // إزالة فئة الإخفاء لعرض التبويب
                tabElement.classList.remove('d-none');
            }
            
            document.querySelectorAll('.admin-nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            element.classList.add('active');
            
            if (tabId === 'adm4') {
                renderMasterReport();
            } else if (tabId === 'adm5') {
                // عند الانتقال إلى تبويب الإحصائيات، قم بتحديث الإحصائيات والنظرة العامة لتجديد أرقامها وأحداثها
                updateStats();
                setTimeout(() => {
                    updateStatsChart();
                }, 100);
            } else if (tabId === 'adm3') {
                renderAdminSwaps();
            }
        }

        function showEmpDetails() {
            if(!currentEmpData) return;
            
            const schedule = currentEmpData.schedule || [];
            const workDays = schedule.filter(s => !s.wasSwappedOut).length;
            const swapDays = schedule.filter(s => s.isSwapped || s.wasSwappedOut).length;
            
            let scheduleHtml = '';
            if(schedule.length > 0) {
                schedule.forEach(s => {
                    scheduleHtml += `
                        <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
                            <div>
                                <span class="fw-bold">${s.date}</span>
                                <small class="text-muted ms-2">(${getDayAr(s.date)})</small>
                            </div>
                            <div>
                                ${(s.isSwapped || s.wasSwappedOut) ? 
                                    `<span class="badge bg-primary">تبديل مع ${s.swappedWith || 'غير معروف'}</span>` :
                                    `<span class="badge bg-success">أساسي</span>`}
                            </div>
                        </div>`;
                });
            }
            
            Swal.fire({
                title: currentEmpData.name,
                html: `
                    <div class="text-start">
                        <div class="row mb-3">
                            <div class="col-6">
                                <div class="p-3 bg-light rounded">
                                    <h6 class="fw-bold">الرقم القومي</h6>
                                    <p class="mb-0">${currentEmpData.nationalId}</p>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-3 bg-light rounded">
                                    <h6 class="fw-bold">أيام الملاحظات</h6>
                                    <p class="mb-0">${workDays} يوم</p>
                                </div>
                            </div>
                        </div>
                        
                        ${schedule.length > 0 ? `
                        <div class="mb-3">
                            <h6 class="fw-bold">جدول الملاحظات</h6>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${scheduleHtml}
                            </div>
                        </div>` : ''}
                        
                        <div class="mt-4">
                            <p class="text-muted small"><i class="fas fa-info-circle me-1"></i>لطلب تبديل في يوم معين، انقر على زر التبديل بجانب اليوم في الجدول</p>
                        </div>
                    </div>
                `,
                width: 600,
                showConfirmButton: false,
                showCloseButton: true
            });
        }

        function showSwapDetails(date) {
            if(!currentEmpData) return;
            
            const swap = currentEmpData.schedule.find(s => s.date === date);
            if(!swap) return;
            
            Swal.fire({
                title: 'تفاصيل التبديل',
                html: `
                    <div class="text-start">
                        <div class="mb-3">
                            <h6 class="fw-bold">التاريخ</h6>
                            <p>${date} (${getDayAr(date)})</p>
                        </div>
                        
                        <div class="mb-3">
                            <h6 class="fw-bold">النوع</h6>
                            <!-- استبدال كلمة "نقل" بـ "تبديل مع" بشكل دائم لمزيد من الاتساق -->
                            <p>تبديل مع</p>
                        </div>
                        
                        <div class="mb-3">
                            <!-- دائماً استخدم "التبديل مع" بدلاً من "النقل إلى" -->
                            <h6 class="fw-bold">التبديل مع</h6>
                            <p>${swap.swappedWith || 'غير معروف'}</p>
                        </div>
                        
                        <div class="mt-4">
                            <!-- عرض رسالة ثابتة بدلاً من استخدام شرط ternary للتوضيح -->
                            <p class="text-muted small"><i class="fas fa-info-circle me-1"></i>هذا اليوم تم تبديله مع زميل آخر</p>
                        </div>
                    </div>
                `,
                showConfirmButton: true,
                confirmButtonText: 'حسناً'
            });
        }

        /**
         * إظهار رسالة عائمة مختصرة باستخدام SweetAlert2. تستخدم هذه الدالة لعرض
         * نتيجة الموافقة أو الرفض لطلبات التبديل بدون عرض بقية الإشعارات.
         * @param {string} message نص الرسالة
         * @param {string} type نوع الإشعار: 'success' للموافقة، 'error' للرفض
         */
        function showToast(message, type) {
            /**
             * إظهار توست بشكل جذاب مع تأثيرات حركة. يختلف الأيقون حسب نوع الرسالة
             * (نجاح/خطأ/معلومة). استخدم animate.css لجعل التوست ينزلق إلى الداخل
             * ويختفي بسلاسة. كما تم تعيين customClass إلى "custom-toast" ليتم
             * تطبيق أنماط CSS البيضاوية والألوان.
             */
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: type === 'success' ? 'success' : type === 'error' ? 'error' : 'info',
                title: message,
                showConfirmButton: false,
                timer: 4000,
                timerProgressBar: true,
                customClass: {
                    popup: 'custom-toast'
                },
                showClass: {
                    popup: 'animate__animated animate__fadeInRight animate__faster'
                },
                hideClass: {
                    popup: 'animate__animated animate__fadeOutRight animate__faster'
                }
            });
        }

        function updateNotificationBadge() {
            if(!currentEmpData) return;
            
            const notifications = currentEmpData.notifications || [];
            // أولاً: اعرض رسائل الموافقة أو الرفض غير المقروءة فقط
            const unreadResponses = notifications.filter(n => !n.read && n.type === 'swap_response');
            if (unreadResponses.length > 0) {
                unreadResponses.forEach(n => {
                    const respType = (n.response === 'approved' || n.response === 'success') ? 'success' : (n.response === 'rejected' ? 'error' : 'info');
                    showToast(n.message || 'تم تحديث حالة طلب التبديل', respType);
                });
                // بعد عرضها، قم بتعليمها كمقروءة وتحديث البيانات
                const updatedNotifications = notifications.map(n => {
                    if (!n.read && n.type === 'swap_response') {
                        return {...n, read: true};
                    }
                    return n;
                });
                currentEmpData.notifications = updatedNotifications;
                const empIndex = allEmployees.findIndex(e => e.nationalId === currentEmpData.nationalId);
                if (empIndex !== -1) {
                    allEmployees[empIndex].notifications = updatedNotifications;
                    allEmployees[empIndex].lastUpdated = new Date().toISOString();
                }
                // احفظ التغييرات في Firebase
                saveDataToFirebase();
            }
            
            // حساب عدد الإشعارات غير المقروءة المتبقية (باستثناء الرسائل التي تم قراءتها للتو)
            const unread = (currentEmpData.notifications || []).filter(n => !n.read).length;
            // احتساب عدد طلبات التبديل الواردة
            const incomingSwaps = allEmployees.reduce((count, emp) => {
                return count + (emp.pendingSwaps || []).filter(p => 
                    p.targetId === currentEmpData.nationalId && p.status === 'pending'
                ).length;
            }, 0);
            
            // إزالة عرض الإشعارات السابق تلقائياً؛ لن يتم فتح نافذة الإشعارات تلقائياً
            window.swapPopupShown = false;

            const totalNotifications = unread + incomingSwaps;
            
            const badge = document.getElementById('notifBadge');
            if(totalNotifications > 0) {
                badge.style.display = 'flex';
                badge.innerText = totalNotifications > 9 ? '9+' : totalNotifications;
            } else {
                badge.style.display = 'none';
            }

            // بعد تحديث الشارة، تحقق من وجود طلبات تبديل جديدة لعرضها مباشرة
            if (typeof checkIncomingSwapRequests === 'function') {
                try {
                    checkIncomingSwapRequests();
                } catch (err) {
                    console.error('تعذر التحقق من طلبات التبديل الواردة:', err);
                }
            }
        }

        /**
         * يعرض تلقائياً للمستخدم أي طلبات تبديل واردة لم يتم قراءتها. يعرض حواراً تفاعلياً
         * يتيح للمستخدم الموافقة أو الرفض بدون الحاجة لفتح الإشعارات.
         */
        async function checkIncomingSwapRequests() {
            if (!currentEmpData) return;
            const notifications = currentEmpData.notifications || [];
            // احصل على كل الإشعارات من نوع طلب التبديل وغير المقروءة
            const pendingNotifs = notifications.filter(n => !n.read && n.type === 'swap_request');
            if (pendingNotifs.length === 0) return;
            // معالجة كل إشعار واحداً تلو الآخر لمنع تداخل الحوارات
            for (const notif of pendingNotifs) {
                // البحث عن تفاصيل الطلب في قائمة الموظفين
                let sender = null;
                let request = null;
                for (const emp of allEmployees) {
                    const req = (emp.pendingSwaps || []).find(r => r.requestId === notif.requestId);
                    if (req) {
                        sender = emp;
                        request = req;
                        break;
                    }
                }
                if (!request || !sender) {
                    // إذا لم يتم العثور على الطلب قم بتمييز الإشعار كمقروء وتابع
                    notif.read = true;
                    continue;
                }
                // عرض حوار الموافقة/الرفض
                const formattedSenderName = getNameWithPrefix(sender);
                const dateStr = request.myDate;
                const dayName = getDayAr(dateStr);
                const message = request.message ? `<p class="mt-2"><small class="text-muted">"${request.message}"</small></p>` : '';
                const result = await Swal.fire({
                    title: 'طلب تبديل وارد',
                    html: `<div class="text-start">${formattedSenderName} يريد التبديل معك يوم <b>${dateStr}</b> (${dayName})${message}</div>`,
                    icon: 'info',
                    showCancelButton: true,
                    showDenyButton: true,
                    confirmButtonText: 'موافقة',
                    denyButtonText: 'رفض',
                    cancelButtonText: 'لاحقاً',
                    customClass: {
                        confirmButton: 'btn btn-success',
                        denyButton: 'btn btn-danger',
                        cancelButton: 'btn btn-secondary'
                    }
                });
                // تمييز الإشعار كمقروء بعد عرض الحوار
                notif.read = true;
                if (result.isConfirmed) {
                    // موافقة على الطلب
                    await approveSwap(sender.nationalId, request.requestId);
                } else if (result.isDenied) {
                    // رفض الطلب
                    await rejectSwap(sender.nationalId, request.requestId);
                } else {
                    // المستخدم اختار لاحقاً، لا نفعل شيئاً غير تعليم الإشعار كمقروء
                }
            }
            // حفظ حالة قراءة الإشعارات بعد الانتهاء
            const empIndex = allEmployees.findIndex(e => e.nationalId === currentEmpData.nationalId);
            if (empIndex !== -1) {
                allEmployees[empIndex].notifications = notifications;
                allEmployees[empIndex].lastUpdated = new Date().toISOString();
            }
            await saveDataToFirebase();
            updateNotificationBadge();
        }

        // دالة لعرض جدول الملاحظات اليومي بناءً على التاريخ المختار
        function renderDailyNotes() {
            const dateInput = document.getElementById('dailyNotesDate');
            if(!dateInput) return;
            let date = dateInput.value;
            if(!date) {
                Swal.fire('خطأ', 'يرجى اختيار تاريخ', 'warning');
                return;
            }
            // تحويل التاريخ إلى صيغة موحدة (yyyy-mm-dd)
            const isoDate = (new Date(date)).toISOString().split('T')[0];
            const rows = [];
            allEmployees.forEach(emp => {
                (emp.schedule || []).forEach(sch => {
                    // مقارنة التاريخ بصيغة موحدة للتأكد من المطابقة
                    const schIso = (new Date(sch.date)).toISOString().split('T')[0];
                    if(schIso === isoDate) {
                        const swapped = sch.wasSwappedOut || sch.isSwapped;
                        rows.push({
                            // عرض الاسم مع اللقب المناسب
                            name: getNameWithPrefix(emp) || emp.name || 'غير معروف',
                            nationalId: emp.nationalId || '-',
                            status: swapped ? 'تبديل مع' : 'أساسي',
                            details: sch.swappedWith || '-'
                        });
                    }
                });
            });
            let html = '<table class="table table-bordered text-center align-middle"><thead class="table-light"><tr><th>الاسم</th><th>الرقم القومي</th><th>الحالة</th><th>التفاصيل</th></tr></thead><tbody>';
            if(rows.length > 0) {
                rows.forEach(r => {
                    const badgeClass = (r.status === 'أساسي') ? 'success' : 'primary';
                    html += `<tr><td>${r.name}</td><td>${r.nationalId}</td><td><span class="badge bg-${badgeClass}">${r.status}</span></td><td>${r.details}</td></tr>`;
                });
            } else {
                html += '<tr><td colspan="4">لا توجد بيانات لهذا اليوم</td></tr>';
            }
            html += '</tbody></table>';
            const container = document.getElementById('dailyNotesTableArea');
            if(container) container.innerHTML = html;

            // تحديث عنوان التاريخ للترويسة
            const dateParts = isoDate.split('-');
            const displayDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
            const dateTitle = document.getElementById('dailyNotesDateTitle');
            if(dateTitle) {
                dateTitle.innerText = 'تاريخ: ' + displayDate;
            }
        }

        // دالة لطباعة جدول الملاحظات اليومي
        function printDailyNotes() {
            const tableArea = document.getElementById('dailyNotesTableArea');
            if(!tableArea || tableArea.innerHTML.trim() === '' || tableArea.innerText.includes('لا توجد بيانات')) {
                Swal.fire('لا يوجد بيانات للطباعة', 'يرجى اختيار تاريخ والنقر على عرض قبل الطباعة', 'warning');
                return;
            }
            // إظهار التذييل عند الطباعة
            const header = document.getElementById('dailyNotesHeader');
            const footer = document.getElementById('dailyNotesFooter');
            if(header) header.style.display = 'flex';
            if(footer) footer.style.display = 'block';
            window.print();
            // إعادة إخفاء الترويسة والتذييل بعد الطباعة
            if(header) header.style.display = 'none';
            if(footer) footer.style.display = 'none';
        }

        /**
         * استيراد ملف الملاحظات لموظفين من ملف Excel/CSV
         * يتوقع الملف عمودين: الاسم و تواريخ الملاحظات مفصولة بفواصل.
         * عند وجود اسم في الملف يطابق أحد الموظفين الموجودين في النظام، يتم إضافة التواريخ إلى جدول الملاحظات الخاص به.
         */
        function uploadNotesFile() {
            const fileInput = document.getElementById('notesFile');
            if(!fileInput || !fileInput.files || fileInput.files.length === 0) {
                Swal.fire('خطأ', 'يرجى اختيار ملف أولاً', 'warning');
                return;
            }
            const file = fileInput.files[0];
            const reader = new FileReader();
            const isCSV = file.name.toLowerCase().endsWith('.csv');
            reader.onload = function(e) {
                try {
                    if(isCSV) {
                        // Parse CSV manually
                        const text = e.target.result;
                        const rows = text.split(/\r?\n/).filter(r => r.trim() !== '');
                        rows.forEach((row, idx) => {
                            const cols = row.split(',');
                            if(cols.length < 2) return;
                            const name = cols[0].trim();
                            const datesStr = cols.slice(1).join(',');
                            processEmployeeNotesRow(name, datesStr);
                        });
                    } else {
                        // Parse Excel using XLSX
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const sheet = workbook.Sheets[sheetName];
                        const rows = XLSX.utils.sheet_to_json(sheet, { header:1 });
                        rows.forEach((row, idx) => {
                            if(!row || row.length < 2) return;
                            // Skip header if string values like "name" or "dates"
                            if(idx === 0) {
                                const firstCell = String(row[0] || '').toLowerCase();
                                if(firstCell.includes('الاسم') || firstCell.includes('name')) return;
                            }
                            const name = String(row[0]).trim();
                            const datesStr = String(row[1]).trim();
                            processEmployeeNotesRow(name, datesStr);
                        });
                    }
                    Swal.fire('تم الاستيراد', 'تم تحديث الملاحظات للموظفين بنجاح', 'success');
                } catch(err) {
                    console.error(err);
                    Swal.fire('خطأ', 'حدث خطأ أثناء قراءة الملف', 'error');
                }
            };
            if(isCSV) {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        /**
         * معالجة صف من الملف وتحديث بيانات الموظف.
         * @param {string} name اسم الموظف
         * @param {string} datesStr سلسلة تواريخ مفصولة بفواصل
         */
        function processEmployeeNotesRow(name, datesStr) {
            if(!name || !datesStr) return;
            // البحث عن الموظف بالاسم
            const emp = allEmployees.find(e => (e.name || '').trim() === name.trim());
            if(!emp) return;
            const dates = datesStr.split(/[،,\s]+/).filter(d => d.trim() !== '');
            dates.forEach(date => {
                // تأكد من صيغة التاريخ yyyy-mm-dd
                const normalized = normalizeDate(date);
                if(!normalized) return;
                if(!emp.schedule) emp.schedule = [];
                // إذا كان التاريخ موجود بالفعل، لا تضف مرة أخرى
                const exists = emp.schedule.some(s => s.date === normalized);
                if(!exists) {
                    emp.schedule.push({ date: normalized, isSwapped: false, wasSwappedOut: false, swappedWith: null });
                }
            });
        }

        /**
         * تحويل التاريخ إلى صيغة yyyy-mm-dd إذا كان ممكناً
         * يقبل أشكالاً متعددة مثل dd/mm/yyyy أو dd-mm-yyyy
         */
        function normalizeDate(dateStr) {
            if(!dateStr) return null;
            // استبدال أي فواصل عربية أو فراغات بفواصل عادية
            let d = dateStr.replace(/\s+/g, '').replace(/،/g,',');
            // إذا كان التنسيق يتضمن شرطة أو slash
            const parts = d.split(/[-\/]/);
            if(parts.length === 3) {
                let day = parts[0], month = parts[1], year = parts[2];
                if(year.length === 2) {
                    year = '20' + year;
                }
                if(day.length === 1) day = '0' + day;
                if(month.length === 1) month = '0' + month;
                return `${year}-${month}-${day}`;
            }
            // إذا كان التنسيق بالفعل yyyy-mm-dd
            if(/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
            // لا يمكن تحويل
            return null;
        }
        async function showNotifications() {
            if(!currentEmpData) return;
            
            const notifications = currentEmpData.notifications || [];
            const incomingSwaps = [];
            
            allEmployees.forEach(emp => {
                (emp.pendingSwaps || []).forEach(swap => {
                    if(swap.targetId === currentEmpData.nationalId && swap.status === 'pending') {
                        incomingSwaps.push({
                            ...swap,
                            senderName: emp.name,
                            senderId: emp.nationalId
                        });
                    }
                });
            });
            
            let html = '';
            
            if(incomingSwaps.length > 0) {
                html += `<div class="mb-4">
                    <h6 class="fw-bold text-warning mb-3"><i class="fas fa-exchange-alt me-2"></i>طلبات تبديل واردة</h6>`;
                
                incomingSwaps.forEach(swap => {
                    html += `
                        <div class="border-start border-warning border-3 ps-3 mb-3 py-2">
                            <p class="mb-1"><b>${swap.senderName || 'غير معروف'}</b> يريد التبديل معك يوم <b>${swap.myDate}</b></p>
                            ${swap.message ? `<small class="text-muted d-block mb-2">"${swap.message}"</small>` : ''}
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-success btn-sm" onclick="approveSwap('${swap.senderId}', '${swap.requestId}')">موافقة</button>
                                <button type="button" class="btn btn-danger btn-sm" onclick="rejectSwap('${swap.senderId}', '${swap.requestId}')">رفض</button>
                            </div>
                        </div>`;
                });
                
                html += `</div>`;
            }
            
            if(notifications.length > 0) {
                html += `<div>
                    <h6 class="fw-bold text-primary mb-3"><i class="fas fa-bell me-2"></i>الإشعارات</h6>`;
                
                notifications.slice(0, 5).forEach((notif, index) => {
                    html += `
                        <div class="d-flex justify-content-between align-items-start border-bottom pb-2 mb-2 ${notif.read ? '' : 'fw-bold'}">
                            <div>
                                <p class="mb-1">${notif.message || 'إشعار بدون نص'}</p>
                                <small class="text-muted">${notif.timestamp ? new Date(notif.timestamp).toLocaleString('ar-EG') : 'تاريخ غير معروف'}</small>
                            </div>
                            ${!notif.read ? `<span class="badge bg-primary badge-dot"></span>` : ''}
                        </div>`;
                });
                
                if(notifications.length > 5) {
                    html += `<p class="text-center text-muted small mt-2">و ${notifications.length - 5} إشعار إضافي</p>`;
                }
                
                html += `</div>`;
            }
            
            if(html === '') {
                html = '<div class="text-center py-4"><i class="fas fa-bell-slash fa-2x text-muted mb-3"></i><p>لا توجد إشعارات</p></div>';
            }
            
            Swal.fire({
                title: 'الإشعارات',
                html: html,
                width: 500,
                showCloseButton: true,
                showConfirmButton: false
            });
            
            if(notifications.some(n => !n.read)) {
                const updatedNotifications = notifications.map(n => ({...n, read: true}));
                currentEmpData.notifications = updatedNotifications;
                
                const empIndex = allEmployees.findIndex(e => e.nationalId === currentEmpData.nationalId);
                if (empIndex !== -1) {
                    allEmployees[empIndex].notifications = updatedNotifications;
                    allEmployees[empIndex].lastUpdated = new Date().toISOString();
                }
                
                await saveDataToFirebase();
                
                updateNotificationBadge();
            }
        }

        async function approveSwap(senderId, requestId) {
            Swal.close();
            
            const sender = allEmployees.find(e => e.nationalId === senderId);
            if (!sender) {
                Swal.fire('خطأ', 'المرسل غير موجود', 'error');
                return;
            }
            
            const request = (sender.pendingSwaps || []).find(r => r.requestId === requestId);
            if (!request) {
                Swal.fire('خطأ', 'طلب التبديل غير موجود', 'error');
                return;
            }
            
            try {
                const senderIndex = allEmployees.findIndex(e => e.nationalId === senderId);
                const currentEmpIndex = currentEmpData ? allEmployees.findIndex(e => e.nationalId === currentEmpData.nationalId) : -1;
                
                if (senderIndex !== -1) {
                    allEmployees[senderIndex].schedule = allEmployees[senderIndex].schedule.map(s => 
                        s.date === request.myDate ? {...s, wasSwappedOut: true, swappedWith: currentEmpData.name} : s
                    );
                    allEmployees[senderIndex].pendingSwaps = allEmployees[senderIndex].pendingSwaps.map(r => 
                        r.requestId === requestId ? {...r, status: 'completed'} : r
                    );
                    // إضافة إشعار للمرسل يفيد بأن طلب التبديل تمت الموافقة عليه
                    if (!allEmployees[senderIndex].notifications) {
                        allEmployees[senderIndex].notifications = [];
                    }
                    allEmployees[senderIndex].notifications.push({
                        type: 'swap_response',
                        response: 'approved',
                        // تضمين اسم اليوم لتوضيح أكبر في الإشعار العائم
                        message: `تمت الموافقة على طلب التبديل ليوم ${request.myDate} (${getDayAr(request.myDate)})${currentEmpData && currentEmpData.name ? ' مع ' + getNameWithPrefix(currentEmpData) : ''}`,
                        timestamp: new Date().toISOString(),
                        read: false
                    });
                    allEmployees[senderIndex].lastUpdated = new Date().toISOString();
                }
                
                if (currentEmpIndex !== -1) {
                    const newSchedule = [...(allEmployees[currentEmpIndex].schedule || [])];
                    newSchedule.push({
                        date: request.myDate,
                        isSwapped: true,
                        swappedWith: sender.name,
                        wasSwappedOut: false
                    });
                    allEmployees[currentEmpIndex].schedule = newSchedule;
                    allEmployees[currentEmpIndex].lastUpdated = new Date().toISOString();
                    
                    if (currentEmpData) {
                        currentEmpData.schedule = newSchedule;
                    }
                }
                
                const saved = await saveDataToFirebase();
                
                if (saved) {
                    Swal.fire({
                        icon: 'success',
                        title: 'تم التبديل',
                        text: 'تمت عملية التبديل بنجاح ',
                        timer: 2000,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire({
                        icon: 'success',
                        title: 'تم التبديل',
                        text: 'تمت عملية التبديل بنجاح ',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }
                
                if (currentEmpData) {
                    renderEmpUI();
                    updateNotificationBadge();
                }
                // تحديث القوائم الأخرى حتى لا يحتاج المستخدم للتنقل لإعادة تحميلها
                renderAdminEmps();
                if (typeof renderAdminSwaps === 'function') {
                    try {
                        renderAdminSwaps();
                    } catch (err) {
                        console.error('تعذر تحديث قائمة التبديلات بعد الموافقة:', err);
                    }
                }
                if (typeof renderMasterReport === 'function') {
                    try {
                        renderMasterReport();
                    } catch (err) {
                        console.error('تعذر تحديث الجدول العام بعد الموافقة:', err);
                    }
                }
                if (typeof renderAssignmentOverview === 'function') {
                    try {
                        renderAssignmentOverview();
                    } catch (err) {
                        console.error('تعذر تحديث التوزيع بعد الموافقة:', err);
                    }
                }
                updateStats();
                
            } catch (error) {
                console.error('خطأ في الموافقة:', error);
                Swal.fire('خطأ', 'تعذر تنفيذ العملية', 'error');
            }
        }

        async function rejectSwap(senderId, requestId) {
            Swal.close();
            
            try {
                const senderIndex = allEmployees.findIndex(e => e.nationalId === senderId);
                if (senderIndex === -1) {
                    Swal.fire('خطأ', 'المرسل غير موجود', 'error');
                    return;
                }
                
                const request = (allEmployees[senderIndex].pendingSwaps || []).find(r => r.requestId === requestId);
                if (!request) {
                    Swal.fire('خطأ', 'طلب التبديل غير موجود', 'error');
                    return;
                }
                
                allEmployees[senderIndex].pendingSwaps = allEmployees[senderIndex].pendingSwaps.map(r => 
                    r.requestId === requestId ? {...r, status: 'rejected', rejectedAt: new Date().toISOString()} : r
                );

                // إضافة إشعار للمرسل يفيد بأن طلب التبديل تم رفضه
                if (!allEmployees[senderIndex].notifications) {
                    allEmployees[senderIndex].notifications = [];
                }
                allEmployees[senderIndex].notifications.push({
                    type: 'swap_response',
                    response: 'rejected',
                    // تضمين اسم اليوم في إشعار الرفض لتوضيح أكبر
                    message: `تم رفض طلب التبديل ليوم ${request.myDate} (${getDayAr(request.myDate)})${currentEmpData && currentEmpData.name ? ' بواسطة ' + getNameWithPrefix(currentEmpData) : ''}`,
                    timestamp: new Date().toISOString(),
                    read: false
                });
                
                allEmployees[senderIndex].lastUpdated = new Date().toISOString();
                
                const saved = await saveDataToFirebase();
                
                if (saved) {
                    Swal.fire({
                        icon: 'info',
                        title: 'تم الرفض',
                        text: 'تم رفض طلب التبديل وحفظه في السحابة',
                        timer: 2000,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire({
                        icon: 'info',
                        title: 'تم الرفض',
                        text: 'تم رفض طلب التبديل (محلياً فقط)',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }
                
                renderAdminEmps();
                if (typeof renderAdminSwaps === 'function') {
                    try {
                        renderAdminSwaps();
                    } catch (err) {
                        console.error('تعذر تحديث قائمة التبديلات بعد الرفض:', err);
                    }
                }
                updateStats();
                updateNotificationBadge();
                
            } catch (error) {
                console.error('خطأ في الرفض:', error);
                Swal.fire('خطأ', 'تعذر رفض الطلب', 'error');
            }
        }

        function renderAdminSwaps() {
            let pendingRequests = [];
            let completedRequests = [];
            
            allEmployees.forEach(employee => {
                (employee.pendingSwaps || []).forEach(request => {
                    const target = allEmployees.find(e => e.nationalId === request.targetId);
                    const requestWithDetails = {
                        ...request,
                        senderName: getNameWithPrefix(employee),
                        senderId: employee.nationalId,
                        targetName: target ? getNameWithPrefix(target) : 'غير معروف'
                    };
                    
                    if(request.status === 'completed') {
                        completedRequests.push(requestWithDetails);
                    } else if (request.status === 'pending') {
                        pendingRequests.push(requestWithDetails);
                    }
                });
            });
            
            let pendingHtml = '';
            if(pendingRequests.length > 0) {
                pendingRequests.forEach(req => {
                    pendingHtml += `
                        <div class="request-card status-pending p-3 mb-3 animate__animated animate__fadeIn" 
                             onclick="showSwapRequestDetails('${req.senderId}', '${req.requestId}')">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="d-flex align-items-center mb-1">
                                        <i class="fas fa-user-circle text-primary me-2"></i>
                                        <b>${req.senderName}</b>
                                        <i class="fas fa-arrow-left mx-2 text-muted"></i>
                                        <i class="fas fa-user-circle text-success me-2"></i>
                                        <b>${req.targetName}</b>
                                    </div>
                                    <small class="text-muted">
                                        <i class="fas fa-calendar-day me-1"></i>${req.myDate} (${getDayAr(req.myDate)})
                                    </small>
                                    ${req.message ? `<p class="mt-2 small text-muted">"${req.message}"</p>` : ''}
                                </div>
                                <div>
                                    <span class="badge bg-warning">قيد الانتظار</span>
                                    <button type="button" class="btn btn-sm btn-success mt-2" onclick="event.stopPropagation(); approveSwapAdmin('${req.senderId}', '${req.requestId}')">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-danger mt-2 ms-1" onclick="event.stopPropagation(); rejectSwapAdmin('${req.senderId}', '${req.requestId}')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger mt-2 ms-1" onclick="event.stopPropagation(); deleteSwapAdmin('${req.senderId}', '${req.requestId}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>`;
                });
            } else {
                pendingHtml = '<div class="text-center py-4 text-muted"><i class="fas fa-inbox fa-2x mb-3"></i><p>لا توجد طلبات معلقة</p></div>';
            }
            
            document.getElementById('pendingSwapsList').innerHTML = pendingHtml;
            
            let completedHtml = '';
            if(completedRequests.length > 0) {
                    completedRequests.slice(0, 10).forEach(req => {
                    completedHtml += `
                        <div class="request-card status-approved p-3 mb-2" 
                             onclick="showSwapRequestDetails('${req.senderId}', '${req.requestId}')">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <small class="text-muted">${req.myDate}</small>
                                    <div class="mt-1">
                                        <b>${req.senderName}</b> <i class="fas fa-arrow-left mx-1 text-muted"></i> <b>${req.targetName}</b>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center gap-1">
                                    <span class="badge bg-success">مكتمل</span>
                                    <!-- إزالة زر الحذف للطلبات المكتملة لجعل الواجهة أبسط -->
                                </div>
                            </div>
                        </div>`;
                    });
                
                if(completedRequests.length > 10) {
                    completedHtml += `<div class="text-center mt-2">
                        <small class="text-muted">و ${completedRequests.length - 10} طلب إضافي</small>
                    </div>`;
                }
            } else {
                completedHtml = '<div class="text-center py-4 text-muted"><i class="fas fa-check-circle fa-2x mb-3"></i><p>لا توجد طلبات مكتملة</p></div>';
            }
            
            document.getElementById('completedSwapsList').innerHTML = completedHtml;
            // بعد حساب الطلبات المعلقة والمكتملة، قم بعرض التبديلات اليدوية أيضاً
            if (typeof renderManualSwaps === 'function') {
                try {
                    renderManualSwaps();
                } catch (err) {
                    console.warn('تعذر عرض التبديلات اليدوية:', err);
                }
            }
        }

        function showSwapRequestDetails(senderId, requestId) {
            const sender = allEmployees.find(e => e.nationalId === senderId);
            if(!sender) return;
            
            const request = (sender.pendingSwaps || []).find(r => r.requestId === requestId);
            if(!request) return;
            
            const target = allEmployees.find(e => e.nationalId === request.targetId);
            
            Swal.fire({
                title: 'تفاصيل طلب التبديل',
                html: `
                    <div class="text-start">
                        <div class="row mb-3">
                            <div class="col-6">
                                <div class="p-3 bg-light rounded">
                                    <h6 class="fw-bold">المرسل</h6>
                                    <p class="mb-1"><i class="fas fa-user me-2"></i>${getNameWithPrefix(sender)}</p>
                                    <small class="text-muted">${sender.nationalId}</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-3 bg-light rounded">
                                    <h6 class="fw-bold">المستلم</h6>
                                    <p class="mb-1"><i class="fas fa-user me-2"></i>${target ? getNameWithPrefix(target) : 'غير معروف'}</p>
                                    <small class="text-muted">${request.targetId}</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <h6 class="fw-bold">التاريخ</h6>
                            <p><i class="fas fa-calendar me-2"></i>${request.myDate} (${getDayAr(request.myDate)})</p>
                        </div>
                        
                        ${request.message ? `
                        <div class="mb-3">
                            <h6 class="fw-bold">الرسالة</h6>
                            <div class="p-3 bg-light rounded">
                                "${request.message}"
                            </div>
                        </div>` : ''}
                        
                        <div class="mb-3">
                            <h6 class="fw-bold">الحالة</h6>
                            <span class="badge ${request.status === 'completed' ? 'bg-success' : 
                                                 request.status === 'rejected' ? 'bg-danger' : 'bg-warning'}">
                                ${request.status === 'completed' ? 'مكتمل' : 
                                 request.status === 'rejected' ? 'مرفوض' : 'قيد الانتظار'}
                            </span>
                        </div>
                        
                        <div class="mb-3">
                            <h6 class="fw-bold">تاريخ الطلب</h6>
                            <p>${request.timestamp ? new Date(request.timestamp).toLocaleString('ar-EG') : 'غير معروف'}</p>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: request.status === 'pending' ? 'موافقة' : 'حسناً',
                cancelButtonText: 'إغلاق',
                showDenyButton: request.status === 'pending',
                denyButtonText: 'رفض',
                customClass: {
                    confirmButton: 'btn btn-success',
                    denyButton: 'btn btn-danger',
                    cancelButton: 'btn btn-secondary'
                }
            }).then(result => {
                if(result.isConfirmed && request.status === 'pending') {
                    approveSwapAdmin(senderId, requestId);
                } else if(result.isDenied) {
                    rejectSwapAdmin(senderId, requestId);
                }
            });
        }

        async function approveSwapAdmin(senderId, requestId) {
            const sender = allEmployees.find(e => e.nationalId === senderId);
            const request = (sender.pendingSwaps || []).find(r => r.requestId === requestId);
            const target = allEmployees.find(e => e.nationalId === request.targetId);
            
            if(!sender || !request || !target) {
                Swal.fire('خطأ', 'بيانات الطلب غير مكتملة', 'error');
                return;
            }
            
            try {
                const senderIndex = allEmployees.findIndex(e => e.nationalId === senderId);
                const targetIndex = allEmployees.findIndex(e => e.nationalId === request.targetId);
                
                if (senderIndex !== -1) {
                    allEmployees[senderIndex].schedule = allEmployees[senderIndex].schedule.map(s => 
                        s.date === request.myDate ? {...s, wasSwappedOut: true, swappedWith: target.name} : s
                    );
                    
                    allEmployees[senderIndex].pendingSwaps = allEmployees[senderIndex].pendingSwaps.map(r => 
                        r.requestId === requestId ? {...r, status: 'completed', approvedAt: new Date().toISOString()} : r
                    );
                    
                    allEmployees[senderIndex].lastUpdated = new Date().toISOString();
                }
                
                if (targetIndex !== -1) {
                    const newSchedule = [...(allEmployees[targetIndex].schedule || [])];
                    newSchedule.push({
                        date: request.myDate,
                        isSwapped: true,
                        swappedWith: sender.name,
                        swappedFrom: sender.nationalId
                    });
                    allEmployees[targetIndex].schedule = newSchedule;
                    allEmployees[targetIndex].lastUpdated = new Date().toISOString();
                }

                // إضافة إشعار إلى المرسل والمستهدف يفيد بأن الطلب تمت الموافقة عليه
                // نربط كل إشعار بمعرّف الطلب لسهولة التتبع لاحقاً
                // إشعار لإبلاغ الطرفين بأن الطلب تمت الموافقة عليه بواسطة الإدارة. يتضمن اليوم والتاريخ.
                const approvalNotif = {
                    type: 'swap_response',
                    response: 'approved',
                    // تضمين اليوم والتاريخ والجهة الموافقة لظهورها في الإشعار العائم
                    message: `تمت الموافقة على طلب التبديل ليوم ${request.myDate} (${getDayAr(request.myDate)}) بواسطة الإدارة`,
                    timestamp: new Date().toISOString(),
                    read: false,
                    requestId: requestId
                };
                if (senderIndex !== -1) {
                    if (!allEmployees[senderIndex].notifications) {
                        allEmployees[senderIndex].notifications = [];
                    }
                    allEmployees[senderIndex].notifications.push({ ...approvalNotif });
                    allEmployees[senderIndex].lastUpdated = new Date().toISOString();
                }
                if (targetIndex !== -1) {
                    if (!allEmployees[targetIndex].notifications) {
                        allEmployees[targetIndex].notifications = [];
                    }
                    allEmployees[targetIndex].notifications.push({ ...approvalNotif });
                    allEmployees[targetIndex].lastUpdated = new Date().toISOString();
                }

                const saved = await saveDataToFirebase();
                
                if (saved) {
                    Swal.fire({
                        icon: 'success',
                        title: 'تمت الموافقة',
                        text: 'تمت عملية التبديل بنجاح ',
                        timer: 2000,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire({
                        icon: 'success',
                        title: 'تمت الموافقة',
                        text: 'تمت عملية التبديل بنجاح ',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }
                
                // بعد الموافقة على التبديل، قم بتحديث القوائم والإحصائيات فوراً حتى لا يحتاج المستخدم
                // إلى إعادة تحميل الصفحة أو الخروج والعودة مرة أخرى. كما يتم تحديث الجدول العام
                // وجدول التوزيع ليعكسا التغييرات مباشرة.
                renderAdminEmps();
                renderAdminSwaps();
                updateStats();
                if (typeof renderMasterReport === 'function') {
                    try {
                        renderMasterReport();
                    } catch (err) {
                        console.error('تعذر تحديث الجدول العام بعد الموافقة:', err);
                    }
                }
                if (typeof renderAssignmentOverview === 'function') {
                    try {
                        renderAssignmentOverview();
                    } catch (err) {
                        console.error('تعذر تحديث التوزيع بعد الموافقة:', err);
                    }
                }

                if (currentEmpData) {
                    if (currentEmpData.nationalId === senderId) {
                        const updatedSender = allEmployees.find(e => e.nationalId === senderId);
                        if (updatedSender) {
                            currentEmpData.schedule = updatedSender.schedule;
                            renderEmpUI();
                            updateNotificationBadge();
                        }
                    }
                    if (currentEmpData.nationalId === request.targetId) {
                        const updatedTarget = allEmployees.find(e => e.nationalId === request.targetId);
                        if (updatedTarget) {
                            currentEmpData.schedule = updatedTarget.schedule;
                            renderEmpUI();
                            updateNotificationBadge();
                        }
                    }
                }
            } catch (error) {
                console.error('خطأ في الموافقة:', error);
                Swal.fire('خطأ', 'تعذر تنفيذ العملية', 'error');
            }
        }

        async function rejectSwapAdmin(senderId, requestId) {
            try {
                const senderIndex = allEmployees.findIndex(e => e.nationalId === senderId);
                if (senderIndex === -1) {
                    Swal.fire('خطأ', 'المرسل غير موجود', 'error');
                    return;
                }
                
                const request = (allEmployees[senderIndex].pendingSwaps || []).find(r => r.requestId === requestId);
                if (!request) {
                    Swal.fire('خطأ', 'طلب التبديل غير موجود', 'error');
                    return;
                }
                
                allEmployees[senderIndex].pendingSwaps = allEmployees[senderIndex].pendingSwaps.map(r => 
                    r.requestId === requestId ? {...r, status: 'rejected', rejectedAt: new Date().toISOString()} : r
                );
                
                // إنشاء إشعار لرفض الطلب بحيث يصل للمرسل والمستهدف (إن وجد)
                const rejectNotif = {
                    type: 'swap_response',
                    response: 'rejected',
                    // إشعار يوضح سبب الرفض ومن قام به (الإدارة)
                    message: `تم رفض طلب التبديل ليوم ${request.myDate} (${getDayAr(request.myDate)}) بواسطة الإدارة`,
                    timestamp: new Date().toISOString(),
                    read: false,
                    requestId: requestId
                };
                // إشعار للمرسل
                if (!allEmployees[senderIndex].notifications) {
                    allEmployees[senderIndex].notifications = [];
                }
                allEmployees[senderIndex].notifications.push({ ...rejectNotif });
                allEmployees[senderIndex].lastUpdated = new Date().toISOString();
                // إشعار للطرف الآخر إذا كان الطلب يتضمن هدفاً
                if (request && request.targetId) {
                    const targetIndex = allEmployees.findIndex(e => e.nationalId === request.targetId);
                    if (targetIndex !== -1) {
                        if (!allEmployees[targetIndex].notifications) {
                            allEmployees[targetIndex].notifications = [];
                        }
                        allEmployees[targetIndex].notifications.push({ ...rejectNotif });
                        allEmployees[targetIndex].lastUpdated = new Date().toISOString();
                    }
                }
                
                const saved = await saveDataToFirebase();
                
                if (saved) {
                    Swal.fire({
                        icon: 'info',
                        title: 'تم الرفض',
                        text: 'تم رفض طلب التبديل وحفظه في السحابة',
                        timer: 2000,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire({
                        icon: 'info',
                        title: 'تم الرفض',
                        text: 'تم رفض طلب التبديل (محلياً فقط)',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }
                
                renderAdminEmps();
                renderAdminSwaps();
                updateStats();
                
            } catch (error) {
                console.error('خطأ في الرفض:', error);
                Swal.fire('خطأ', 'تعذر رفض الطلب', 'error');
            }
        }

        // حذف طلب التبديل بشكل كامل بواسطة الإدارة
        async function deleteSwapAdmin(senderId, requestId) {
            Swal.fire({
                title: 'تأكيد الحذف',
                text: 'هل أنت متأكد من حذف طلب التبديل؟',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، احذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#dc3545'
            }).then(async result => {
                if (result.isConfirmed) {
                    try {
                        // إزالة الطلب من قائمة المرسل
                        const senderIndex = allEmployees.findIndex(e => e.nationalId === senderId);
                        if (senderIndex !== -1) {
                            allEmployees[senderIndex].pendingSwaps = (allEmployees[senderIndex].pendingSwaps || []).filter(r => r.requestId !== requestId);
                            allEmployees[senderIndex].lastUpdated = new Date().toISOString();
                        }
                        // إزالة أي إشعار له علاقة بهذا الطلب
                        allEmployees.forEach(emp => {
                            if (emp.notifications) {
                                emp.notifications = emp.notifications.filter(n => !(n.requestId && n.requestId === requestId));
                            }
                        });
                        const saved = await saveDataToFirebase();
                        if (saved) {
                            Swal.fire({ icon:'success', title:'تم الحذف', text:'تم حذف طلب التبديل بنجاح', timer:1500, showConfirmButton:false });
                        } else {
                            Swal.fire({ icon:'success', title:'تم الحذف', text:'تم حذف طلب التبديل محلياً فقط', timer:1500, showConfirmButton:false });
                        }
                        // تحديث الواجهات بعد الحذف
                        if (typeof renderAdminEmps === 'function') renderAdminEmps();
                        if (typeof renderAdminSwaps === 'function') renderAdminSwaps();
                        if (typeof updateStats === 'function') updateStats();
                    } catch (error) {
                        console.error('خطأ في حذف طلب التبديل:', error);
                        Swal.fire('خطأ', 'تعذر حذف طلب التبديل', 'error');
                    }
                }
            });
        }

        /* ==================== التبديلات اليدوية ==================== */
        /**
         * تحميل التبديلات اليدوية من التخزين المحلي.
         */
        function loadManualSwaps() {
            try {
                return JSON.parse(localStorage.getItem('manualSwaps') || '[]');
            } catch (e) {
                return [];
            }
        }

        /**
         * حفظ التبديلات اليدوية في التخزين المحلي وتحديثها في Firebase إن أمكن.
         *
         * @param {Array} arr
         */
        function saveManualSwaps(arr) {
            manualSwaps = arr;
            localStorage.setItem('manualSwaps', JSON.stringify(arr));
            if (typeof updateManualSwapsInFirebase === 'function') {
                updateManualSwapsInFirebase(arr);
            }
        }

        /**
         * مزامنة التبديلات اليدوية من Firebase إلى التخزين المحلي.
         */
        async function syncManualSwapsFromFirebase() {
            if (firebaseInitialized && typeof db !== 'undefined') {
                try {
                    const docRef = db.collection('settings').doc('manualSwaps');
                    const doc = await docRef.get();
                    if (doc.exists) {
                        const list = doc.data().list || doc.data().manualSwaps || [];
                        manualSwaps = list;
                        localStorage.setItem('manualSwaps', JSON.stringify(list));
                    }
                } catch (err) {
                    console.warn('⚠️ تعذر تحميل التبديلات اليدوية من Firebase:', err);
                }
            }
        }

        /**
         * تحديث التبديلات اليدوية في مستند Firebase.
         */
        async function updateManualSwapsInFirebase(arr) {
            if (firebaseInitialized && typeof db !== 'undefined') {
                try {
                    await db.collection('settings').doc('manualSwaps').set({
                        list: arr,
                        lastUpdated: new Date().toISOString()
                    }, { merge: true });
                } catch (err) {
                    console.warn('⚠️ تعذر حفظ التبديلات اليدوية في Firebase:', err);
                }
            }
        }

        /**
         * عرض قائمة التبديلات اليدوية في واجهة الإدارة.
         */
        function renderManualSwaps() {
            const container = document.getElementById('manualSwapsList');
            if (!container) return;
            if (!manualSwaps || manualSwaps.length === 0) {
                container.innerHTML = '<div class="text-center py-3 text-muted"><i class="fas fa-exchange-alt fa-2x mb-2"></i><p class="mb-0">لا توجد تبديلات يدوية</p></div>';
                return;
            }
            let html = '';
            manualSwaps.forEach((swap) => {
                html += `<div class="request-card p-3 mb-2 animate__animated animate__fadeIn">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">${swap.date} (${getDayAr(swap.date)})</small>
                            <div class="mt-1">
                                <b>${swap.emp1Name}</b> <i class="fas fa-arrow-left mx-1 text-muted"></i> <b>${swap.emp2Name}</b>
                            </div>
                        </div>
                        <div class="d-flex gap-1">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="editManualSwap('${swap.id}')"><i class="fas fa-edit"></i></button>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteManualSwap('${swap.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        /**
         * إظهار نموذج لإضافة أو تعديل تبديل يدوي.
         * @param {string} existingId معرف التبديل عند التعديل (اختياري)
         */
        function showManualSwapModal(existingId) {
            let defaultDate = allDates[0] || '';
            let emp1Id = '';
            let emp2Id = '';
            if (existingId) {
                const swap = manualSwaps.find(s => s.id === existingId);
                if (swap) {
                    defaultDate = swap.date;
                    emp1Id = swap.emp1Id;
                    emp2Id = swap.emp2Id;
                }
            }
            let dateOptions = allDates.map(d => `<option value="${d}" ${d===defaultDate ? 'selected' : ''}>${d} (${getDayAr(d)})</option>`).join('');
            let listOptions = allEmployees.map(emp => `<option value="${emp.nationalId}">${getNameWithPrefix(emp)}</option>`).join('');
            const html = `
                <div class="text-start">
                    <div class="mb-3">
                        <label class="form-label">التاريخ</label>
                        <select id="manualSwapDateInput" class="form-select">${dateOptions}</select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">الموظف الأول</label>
                        <input type="text" id="manualSwapEmp1Input" class="form-control" list="manualEmpList" value="${emp1Id}" placeholder="رقم قومي أو اسم">
                        <datalist id="manualEmpList">${listOptions}</datalist>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">الموظف الثاني (متاح)</label>
                        <select id="manualSwapEmp2Select" class="form-select"></select>
                    </div>
                </div>`;
            Swal.fire({
                title: existingId ? 'تعديل تبديل يدوي' : 'إضافة تبديل يدوي',
                html,
                showCancelButton: true,
                confirmButtonText: 'حفظ',
                cancelButtonText: 'إلغاء',
                didOpen: () => {
                    const dateInput = document.getElementById('manualSwapDateInput');
                    const emp1Input = document.getElementById('manualSwapEmp1Input');
                    const emp2Select = document.getElementById('manualSwapEmp2Select');
                    function updateEmp2List() {
                        const selectedDate = dateInput.value;
                        const emp1Val = emp1Input.value.trim();
                        let selectedEmp1 = allEmployees.find(e => e.nationalId === emp1Val);
                        if (!selectedEmp1) {
                            selectedEmp1 = allEmployees.find(e => getNameWithPrefix(e) === emp1Val || e.name === emp1Val);
                        }
                        let options = '<option value="">اختر موظف</option>';
                        allEmployees.forEach(emp => {
                            if (selectedEmp1 && emp.nationalId === selectedEmp1.nationalId) return;
                            const assignment = (emp.schedule || []).find(s => s.date === selectedDate);
                            if (!assignment) {
                                options += `<option value="${emp.nationalId}">${getNameWithPrefix(emp)}</option>`;
                            }
                        });
                        emp2Select.innerHTML = options;
                        if (existingId && emp2Id) {
                            emp2Select.value = emp2Id;
                        }
                    }
                    dateInput.addEventListener('change', updateEmp2List);
                    emp1Input.addEventListener('input', updateEmp2List);
                    updateEmp2List();
                    if (existingId && emp1Id) {
                        dateInput.value = defaultDate;
                        emp1Input.value = emp1Id;
                    }
                },
                preConfirm: () => {
                    const selectedDate = document.getElementById('manualSwapDateInput').value;
                    const emp1Val = document.getElementById('manualSwapEmp1Input').value.trim();
                    const emp2Val = document.getElementById('manualSwapEmp2Select').value.trim();
                    let emp1 = allEmployees.find(e => e.nationalId === emp1Val);
                    if (!emp1) emp1 = allEmployees.find(e => getNameWithPrefix(e) === emp1Val || e.name === emp1Val);
                    const emp2 = allEmployees.find(e => e.nationalId === emp2Val);
                    if (!selectedDate || !emp1 || !emp2) {
                        Swal.showValidationMessage('يرجى اختيار التاريخ والموظفين');
                        return false;
                    }
                    const assignment1 = (emp1.schedule || []).find(s => s.date === selectedDate);
                    if (!assignment1) {
                        Swal.showValidationMessage('الموظف الأول ليس لديه تكليف في هذا اليوم');
                        return false;
                    }
                    const assignment2 = (emp2.schedule || []).find(s => s.date === selectedDate);
                    if (assignment2) {
                        Swal.showValidationMessage('الموظف الثاني لديه تكليف في هذا اليوم');
                        return false;
                    }
                    return { selectedDate, emp1Id: emp1.nationalId, emp2Id: emp2.nationalId };
                }
            }).then(result => {
                if (result.isConfirmed) {
                    const { selectedDate, emp1Id: newEmp1Id, emp2Id: newEmp2Id } = result.value;
                    if (existingId) {
                        updateManualSwap(existingId, newEmp1Id, newEmp2Id, selectedDate);
                    } else {
                        createManualSwap(newEmp1Id, newEmp2Id, selectedDate);
                    }
                }
            });
        }

        // إسناد الدالة إلى كائن window لضمان إمكانية استدعائها من خصائص onclick في HTML
        if (typeof window !== 'undefined') {
            window.showManualSwapModal = showManualSwapModal;
        }

        /* ==================== إحصائيات تفاعلية ==================== */
        /**
         * عرض قائمة بأسماء جميع الموظفين في نافذة منبثقة.
         */
        function showEmployeeList() {
            if (!allEmployees || allEmployees.length === 0) {
                Swal.fire('لا يوجد موظفين', 'لا توجد بيانات موظفين لعرضها', 'info');
                return;
            }
            const listItems = allEmployees.map(emp => `<li class="mb-1"><i class="fas fa-user me-2 text-primary"></i>${getNameWithPrefix(emp)} <span class="text-muted small">(${emp.nationalId})</span></li>`).join('');
            const html = `<ul class="list-unstyled" style="max-height:400px; overflow-y:auto; padding-right:1rem;">${listItems}</ul>`;
            Swal.fire({
                title: 'قائمة الموظفين',
                html: html,
                width: 600,
                confirmButtonText: 'حسناً'
            });
        }

        // جعل الدالة متاحة عبر نافذة المتصفح ليستدعيها onclick
        if (typeof window !== 'undefined') {
            window.showEmployeeList = showEmployeeList;
        }

        /**
         * عرض قائمة التبديلات (الطلبات والمكتملة واليدوية) في نافذة منبثقة.
         */
        function showSwapOverview() {
            let items = [];
            // جمع التبديلات من الطلبات المعلقة والمكتملة
            allEmployees.forEach(emp => {
                (emp.pendingSwaps || []).forEach(swap => {
                    const target = allEmployees.find(e => e.nationalId === swap.targetId);
                    items.push({
                        date: swap.myDate,
                        from: getNameWithPrefix(emp),
                        to: target ? getNameWithPrefix(target) : 'غير معروف',
                        status: swap.status === 'pending' ? 'قيد الانتظار' : 'مكتمل'
                    });
                });
            });
            // إضافة التبديلات اليدوية
            (manualSwaps || []).forEach(swap => {
                items.push({
                    date: swap.date,
                    from: swap.emp1Name,
                    to: swap.emp2Name,
                    status: 'يدوي'
                });
            });
            if (items.length === 0) {
                Swal.fire('لا توجد تبديلات', 'لا توجد بيانات تبديلات لعرضها', 'info');
                return;
            }
            // فرز حسب التاريخ الأحدث أولاً
            items.sort((a,b) => new Date(b.date) - new Date(a.date));
            const rows = items.map(item => `<tr>
                <td>${item.date} (${getDayAr(item.date)})</td>
                <td>${item.from}</td>
                <td>${item.to}</td>
                <td><span class="badge ${item.status==='قيد الانتظار' ? 'bg-warning' : item.status==='مكتمل' ? 'bg-success' : 'bg-info'}">${item.status}</span></td>
            </tr>`).join('');
            const html = `<div style="overflow-x:auto;">
                <table class="table table-bordered table-sm text-center align-middle" style="min-width: 400px;">
                    <thead class="table-light">
                        <tr>
                            <th>التاريخ</th>
                            <th>المرسل</th>
                            <th>المستلم</th>
                            <th>الحالة</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>`;
            Swal.fire({
                title: 'تفاصيل التبديلات',
                html: html,
                width: 700,
                confirmButtonText: 'حسناً'
            });
        }

        // جعل الدالة متاحة عبر نافذة المتصفح ليستدعيها onclick
        if (typeof window !== 'undefined') {
            window.showSwapOverview = showSwapOverview;
        }

        /**
         * إنشاء تبديل يدوي جديد وربط التعديلات بجدول الموظفين.
         */
        function createManualSwap(emp1Id, emp2Id, date) {
            const swapId = 'm' + Date.now().toString();
            const emp1 = allEmployees.find(e => e.nationalId === emp1Id);
            const emp2 = allEmployees.find(e => e.nationalId === emp2Id);
            if (!emp1 || !emp2) return;
            applyManualSwap(emp1, emp2, date);
            const newSwap = {
                id: swapId,
                date: date,
                emp1Id: emp1Id,
                emp1Name: getNameWithPrefix(emp1),
                emp2Id: emp2Id,
                emp2Name: getNameWithPrefix(emp2),
                createdAt: new Date().toISOString()
            };
            manualSwaps.push(newSwap);
            saveManualSwaps(manualSwaps);
            saveDataToFirebase();
            renderManualSwaps();
            renderAdminEmps();
            updateStats();
            if (typeof renderMasterReport === 'function') {
                try { renderMasterReport(); } catch (_) {}
            }
            if (typeof renderAssignmentOverview === 'function') {
                try { renderAssignmentOverview(); } catch (_) {}
            }
            Swal.fire({ icon:'success', title:'تم الحفظ', text:'تم إنشاء التبديل اليدوي بنجاح', timer:1500, showConfirmButton:false });
        }

        /**
         * تعديل تبديل يدوي قائم. يتم أولاً التراجع عن التبديل القديم، ثم تطبيق الجديد.
         */
        function updateManualSwap(swapId, newEmp1Id, newEmp2Id, date) {
            const idx = manualSwaps.findIndex(s => s.id === swapId);
            if (idx === -1) return;
            const oldSwap = manualSwaps[idx];
            revertManualSwap(oldSwap);
            manualSwaps[idx] = {
                ...oldSwap,
                emp1Id: newEmp1Id,
                emp1Name: getNameWithPrefix(allEmployees.find(e => e.nationalId === newEmp1Id)) || '',
                emp2Id: newEmp2Id,
                emp2Name: getNameWithPrefix(allEmployees.find(e => e.nationalId === newEmp2Id)) || '',
                date: date,
                updatedAt: new Date().toISOString()
            };
            const emp1 = allEmployees.find(e => e.nationalId === newEmp1Id);
            const emp2 = allEmployees.find(e => e.nationalId === newEmp2Id);
            applyManualSwap(emp1, emp2, date);
            saveManualSwaps(manualSwaps);
            saveDataToFirebase();
            renderManualSwaps();
            renderAdminEmps();
            updateStats();
            if (typeof renderMasterReport === 'function') {
                try { renderMasterReport(); } catch (_) {}
            }
            if (typeof renderAssignmentOverview === 'function') {
                try { renderAssignmentOverview(); } catch (_) {}
            }
            Swal.fire({ icon:'success', title:'تم التعديل', text:'تم تعديل التبديل اليدوي بنجاح', timer:1500, showConfirmButton:false });
        }

        /**
         * حذف تبديل يدوي واسترجاع التعديلات من جداول الموظفين.
         */
        function deleteManualSwap(swapId) {
            const idx = manualSwaps.findIndex(s => s.id === swapId);
            if (idx === -1) return;
            const swap = manualSwaps[idx];
            Swal.fire({
                title:'تأكيد الحذف',
                text:'هل أنت متأكد من حذف التبديل اليدوي؟',
                icon:'warning',
                showCancelButton:true,
                confirmButtonText:'نعم، احذف',
                cancelButtonText:'إلغاء',
                confirmButtonColor:'#dc3545'
            }).then(res => {
                if (res.isConfirmed) {
                    revertManualSwap(swap);
                    manualSwaps.splice(idx, 1);
                    saveManualSwaps(manualSwaps);
                    saveDataToFirebase();
                    renderManualSwaps();
                    renderAdminEmps();
                    updateStats();
                    if (typeof renderMasterReport === 'function') {
                        try { renderMasterReport(); } catch (_) {}
                    }
                    if (typeof renderAssignmentOverview === 'function') {
                        try { renderAssignmentOverview(); } catch (_) {}
                    }
                    Swal.fire({ icon:'success', title:'تم الحذف', text:'تم حذف التبديل اليدوي بنجاح', timer:1500, showConfirmButton:false });
                }
            });
        }

        /**
         * استدعاء تحرير التبديل اليدوي. هذه الوظيفة مجرد غلاف يستدعي النموذج
         * الخاص بالتعديل أو الإضافة مع تمرير معرف التبديل. عند النقر على زر
         * التعديل في قائمة التبديلات اليدوية، يتم استدعاء هذه الوظيفة.
         *
         * @param {string} id معرف التبديل
         */
        function editManualSwap(id) {
            showManualSwapModal(id);
        }

        // جعل الدالة متاحة من خلال window
        if (typeof window !== 'undefined') {
            window.editManualSwap = editManualSwap;
        }

        /**
         * تطبيق تبديل يدوي على جداول الموظفين.
         */
        function applyManualSwap(emp1, emp2, date) {
            if (!emp1 || !emp2) return;
            emp1.schedule = emp1.schedule.map(a => {
                if (a.date === date) {
                    return { ...a, wasSwappedOut: true, swappedWith: emp2.name };
                } else {
                    return a;
                }
            });
            emp1.lastUpdated = new Date().toISOString();
            const newAssign = {
                date: date,
                isSwapped: true,
                swappedWith: emp1.name,
                swappedFrom: emp1.nationalId
            };
            emp2.schedule = [...(emp2.schedule || []).filter(a => a.date !== date), newAssign];
            emp2.lastUpdated = new Date().toISOString();
        }

        /**
         * التراجع عن تبديل يدوي واستعادة حالة الجداول كما كانت.
         */
        function revertManualSwap(swap) {
            const emp1 = allEmployees.find(e => e.nationalId === swap.emp1Id);
            const emp2 = allEmployees.find(e => e.nationalId === swap.emp2Id);
            if (!emp1 || !emp2) return;
            emp1.schedule = emp1.schedule.map(a => {
                if (a.date === swap.date) {
                    const restored = { ...a };
                    delete restored.wasSwappedOut;
                    delete restored.swappedWith;
                    return restored;
                } else {
                    return a;
                }
            });
            emp2.schedule = (emp2.schedule || []).filter(a => !(a.date === swap.date && a.isSwapped && a.swappedFrom === swap.emp1Id));
        }
        function showQuickActions() {
            document.getElementById('quickActionsModal').classList.remove('d-none');
        }

        function hideQuickActions() {
            document.getElementById('quickActionsModal').classList.add('d-none');
        }

        function showHelp() {
            // جلب التعليمات من التخزين المحلي. إذا كانت هناك تعليمات مضافة بواسطة الإدارة
            // سيتم عرضها للمستخدم. في حال عدم وجود تعليمات مخصصة، ستظهر نصائح الاستخدام
            // الافتراضية كدليل مبسط.
            const instructions = loadInstructions();
            if (instructions && instructions.length > 0) {
                // عرض التعليمات المخصصة في شكل قائمة نقطية جذابة بدلاً من مربعات ملونة
                const htmlItems = instructions.map(text =>
                    `<li class="mb-2 d-flex align-items-start"><i class="fas fa-circle-check text-primary me-2"></i><span>${text}</span></li>`
                ).join('');
                Swal.fire({
                    title: 'تعليمات هامة',
                    html: `<ul class="list-unstyled text-start mb-0">${htmlItems}</ul>`,
                    width: 550,
                    showConfirmButton: true,
                    confirmButtonText: 'حسناً'
                });
            } else {
                // إذا لم تكن هناك تعليمات مخصصة، نعرض دليل استخدام مبسط بطريقة منظمة
                Swal.fire({
                    title: 'كيفية استخدام النظام',
                    html: `
                        <div class="text-start">
                            <h6 class="fw-bold text-primary mb-2"><i class="fas fa-search me-2"></i>البحث عن الموظف</h6>
                            <p class="mb-2">أدخل الرقم القومي في مربع البحث ثم اضغط على زر "بحث" للعثور على الموظف وعرض جدوله.</p>
                            
                            <h6 class="fw-bold text-warning mb-2"><i class="fas fa-exchange-alt me-2"></i>طلب تبديل</h6>
                            <p class="mb-2">انقر على زر "طلب تبديل" لفتح نافذة التبديل. اختر اليوم الذي تريد تبديله، ثم اختر الزميل المتاح.</p>
                            
                            <h6 class="fw-bold text-success mb-2"><i class="fas fa-bell me-2"></i>الإشعارات</h6>
                            <p class="mb-2">ستظهر رسائل التنبيه تلقائياً عند وصول طلبات جديدة. يمكنك قبول الطلب أو رفضه من الرسالة مباشرة دون الحاجة لفتح الإشعارات.</p>
                            
                            <h6 class="fw-bold text-info mb-2"><i class="fas fa-download me-2"></i>حفظ الجدول</h6>
                            <p class="mb-0">انقر على زر "حفظ كصورة" لتحميل جدولك كصورة يمكن طباعتها أو مشاركتها.</p>
                        </div>
                    `,
                    width: 550,
                    showConfirmButton: true,
                    confirmButtonText: 'حسناً'
                });
            }
        }

        async function refreshSwaps() {
            await loadData();
            renderAdminSwaps();
            Swal.fire({
                icon: 'success',
                title: 'تم التحديث',
                timer: 1000,
                showConfirmButton: false
            });
        }

        function exportSwaps() {
            let swapsData = [];
            
            allEmployees.forEach(emp => {
                (emp.pendingSwaps || []).forEach(swap => {
                    if(swap.status === 'completed') {
                        swapsData.push({
                            'المرسل': emp.name,
                            'المستلم': swap.targetName || 'غير معروف',
                            'التاريخ': swap.myDate,
                            'حالة الطلب': 'مكتمل',
                            'تاريخ الطلب': swap.timestamp ? new Date(swap.timestamp).toLocaleDateString('ar-EG') : 'غير معروف'
                        });
                    }
                });
            });
            
            if(swapsData.length === 0) {
                Swal.fire('تنبيه', 'لا توجد طلبات مكتملة للتصدير', 'info');
                return;
            }
            
            try {
                const ws = XLSX.utils.json_to_sheet(swapsData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'طلبات التبديل');
                
                const fileName = `طلبات_التبديل_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                Swal.fire({
                    icon: 'success',
                    title: 'تم التصدير',
                    text: 'تم حفظ الملف بنجاح',
                    timer: 1500,
                    showConfirmButton: false
                });
            } catch (error) {
                console.error('خطأ في تصدير الطلبات:', error);
                Swal.fire('خطأ', 'تعذر تصدير الملف', 'error');
            }
        }

        window.onload = function() {
            init();

            // تهيئة الألوان المخصصة وحفظها في التخزين المحلي
            function lightenColor(hex, percent) {
                // تحويل اللون سداسي إلى قيم RGB ثم زيادة الإضاءة
                let num = parseInt(hex.replace('#',''), 16);
                let r = (num >> 16) + Math.round(255 * percent / 100);
                let g = ((num >> 8) & 0x00FF) + Math.round(255 * percent / 100);
                let b = (num & 0x0000FF) + Math.round(255 * percent / 100);
                r = r < 255 ? r : 255;
                g = g < 255 ? g : 255;
                b = b < 255 ? b : 255;
                return '#' + (0x1000000 + (r << 16) + (g << 8) + b).toString(16).slice(1);
            }
            function applyColor(col) {
                const light = lightenColor(col, 30);
                document.documentElement.style.setProperty('--primary', col);
                document.documentElement.style.setProperty('--primary-light', light);
            }
            (function() {
                const cp = document.getElementById('colorPicker');
                // توليد لون عشوائي في كل مرة يتم فيها فتح التطبيق
                let randomColor = '#' + Math.floor(Math.random() * 0xffffff).toString(16).padStart(6, '0');
                applyColor(randomColor);
                if (cp) {
                    cp.value = randomColor;
                }
                // حفظ اللون العشوائي في التخزين المحلي بحيث يظهر للمستخدم إذا أراد معرفة الكود
                try {
                    localStorage.setItem('adminColor', randomColor);
                } catch (e) {}
                if(cp) {
                    cp.addEventListener('input', function() {
                        applyColor(this.value);
                        try {
                            localStorage.setItem('adminColor', this.value);
                        } catch (e) {}
                    });
                }
            })();
            
            setTimeout(() => {
                document.querySelectorAll('.animate-on-load').forEach((el, index) => {
                    el.style.animationDelay = `${index * 0.1}s`;
                });
            }, 100);
            
            document.addEventListener('click', function(event) {
                const quickActions = document.getElementById('quickActionsModal');
                const fab = document.querySelector('.floating-action-btn');
                
                if (quickActions && fab) {
                    if(!quickActions.contains(event.target) && !fab.contains(event.target)) {
                        hideQuickActions();
                    }
                }
            });
            
            document.getElementById('nidInput').addEventListener('keypress', function(e) {
                if(e.key === 'Enter') {
                    searchEmployee();
                }
            });
            
            document.getElementById('adminPass').addEventListener('keypress', function(e) {
                if(e.key === 'Enter') {
                    checkAdmin();
                }
            });

            // تحديث الإشعارات والجدول تلقائياً كل 10 ثواني دون الحاجة لإعادة تحميل الصفحة
            setInterval(async function() {
                try {
                    if (typeof currentEmpData !== 'undefined' && currentEmpData) {
                        await loadData();
                        renderEmpUI();
                        updateNotificationBadge();
                    }
                } catch (err) {
                    console.error('خطأ في التحديث التلقائي:', err);
                }
            }, 10000);
            
            setTimeout(() => {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if(loadingOverlay && loadingOverlay.style.display !== 'none') {
                    console.log('🕐 تم تجاوز مهلة التحميل - إظهار الواجهة');
                    loadingOverlay.style.display = 'none';
                    document.getElementById('userInterface').style.display = 'block';
                    
                    loadMockData();
                }
            }, 5000);
        };

        window.onbeforeprint = function() {
            const footer = document.querySelector('.designer-footer');
            if(footer) footer.style.display = 'block';
        };
        
        window.onafterprint = function() {
            const footer = document.querySelector('.designer-footer');
            if(footer) footer.style.display = 'none';
        };
        // ====== وظائف إضافية للتعليمات والقائمة الجانبية ======
        // دالة لتبديل عرض القائمة الجانبية في لوحة التحكم
        function toggleAdminMenu() {
            const topMenu = document.getElementById('adminTopMenu');
            const main = document.getElementById('adminMain');
            if(!topMenu || !main) return;
            if (topMenu.classList.contains('d-none')) {
                // عرض القائمة الأفقية وإزاحة المحتوى للأسفل حتى لا تتداخل معها
                topMenu.classList.remove('d-none');
                main.style.marginTop = '70px';
            } else {
                // إخفاء القائمة الأفقية وإعادة المحتوى لمكانه الطبيعي
                topMenu.classList.add('d-none');
                main.style.marginTop = '';
            }
        }

        /* ===== إدارة التعليمات ===== */
        const instructionColors = ['#e3f2fd', '#e8f5e9', '#fff3e0', '#fce4ec', '#e0f7fa', '#f3e5f5', '#f9fbe7'];
        /**
         * يقوم هذا الدالة بتحميل التعليمات من التخزين المحلي.
         * تتم مزامنة التعليمات من Firebase عند تهيئة التطبيق، لذلك يكون التخزين المحلي دائماً محدثاً.
         */
        function loadInstructions() {
            try {
                return JSON.parse(localStorage.getItem('instructions') || '[]');
            } catch(e) {
                return [];
            }
        }
        /**
         * حفظ مصفوفة التعليمات في التخزين المحلي ثم تحديثها في Firebase إن أمكن.
         * نستخدم دالة غير متزامنة لتحديث Firebase ولكننا لا ننتظرها هنا حتى لا نحجب واجهة المستخدم.
         */
        function saveInstructions(arr) {
            localStorage.setItem('instructions', JSON.stringify(arr));
            // تحديث التعليمات في Firebase إذا كان متاحاً
            if (typeof updateInstructionsInFirebase === 'function') {
                updateInstructionsInFirebase(arr);
            }
        }

        /**
         * مزامنة التعليمات من Firebase إلى التخزين المحلي.
         * يتم استدعاء هذا الدالة بعد تهيئة Firebase مباشرة لضمان توفر التعليمات.
         */
        async function syncInstructionsFromFirebase() {
            if (firebaseInitialized && typeof db !== 'undefined') {
                try {
                    const docRef = db.collection('settings').doc('instructions');
                    const doc = await docRef.get();
                    if (doc.exists) {
                        const list = doc.data().list || doc.data().instructions || [];
                        localStorage.setItem('instructions', JSON.stringify(list));
                    }
                } catch (err) {
                    console.warn('⚠️ تعذر تحميل التعليمات من Firebase:', err);
                }
            }
        }

        /**
         * تحديث التعليمات في مستند Firebase. يستدعى من saveInstructions().
         */
        async function updateInstructionsInFirebase(arr) {
            if (firebaseInitialized && typeof db !== 'undefined') {
                try {
                    await db.collection('settings').doc('instructions').set({
                        list: arr,
                        lastUpdated: new Date().toISOString()
                    }, { merge: true });
                } catch (err) {
                    console.warn('⚠️ تعذر حفظ التعليمات في Firebase:', err);
                }
            }
        }
        function renderAdminInstructions() {
            const list = document.getElementById('instructionList');
            if(!list) return;
            const instructions = loadInstructions();
            list.innerHTML = '';
            instructions.forEach((text, idx) => {
                const color = instructionColors[idx % instructionColors.length];
                const li = document.createElement('li');
                li.className = 'instruction-item d-flex justify-content-between align-items-center mb-2 p-2 rounded';
                li.innerHTML = `<div><span class="bullet me-2" style="background:${color};width:12px;height:12px;display:inline-block;border-radius:50%;"></span>${text}</div><button class="btn btn-sm btn-danger" onclick="deleteInstruction(${idx})"><i class="fas fa-trash"></i></button>`;
                list.appendChild(li);
            });
        }
        function renderUserInstructions() {
            const container = document.getElementById('userInstructions');
            if(!container) return;
            const instructions = loadInstructions();
            if(instructions.length === 0) {
                container.classList.add('d-none');
                return;
            }
            container.classList.remove('d-none');
            container.innerHTML = '<h5 class="fw-bold mb-3"><i class="fas fa-info-circle me-2"></i> تعليمات مهمة</h5>';
            instructions.forEach((text, idx) => {
                const color = instructionColors[idx % instructionColors.length];
                const div = document.createElement('div');
                div.className = 'instruction-point p-2 rounded mb-2';
                div.style.backgroundColor = color;
                div.innerText = text;
                container.appendChild(div);
            });
        }
        function addInstruction() {
            const input = document.getElementById('instructionInput');
            if(!input) return;
            const text = input.value.trim();
            if(!text) return;
            const instructions = loadInstructions();
            instructions.push(text);
            saveInstructions(instructions);
            input.value = '';
            renderAdminInstructions();
            renderUserInstructions();
        }
        function deleteInstruction(index) {
            const instructions = loadInstructions();
            instructions.splice(index, 1);
            saveInstructions(instructions);
            renderAdminInstructions();
            renderUserInstructions();
        }
        // عند تحميل الصفحة، قم بمزامنة التعليمات من Firebase ثم عرضها للمستخدم
        document.addEventListener('DOMContentLoaded', async () => {
            if (typeof syncInstructionsFromFirebase === 'function') {
                await syncInstructionsFromFirebase();
            }
            // لم يعد يتم عرض التعليمات تلقائياً للمستخدم في الصفحة الرئيسية.
            // سيتم عرضها فقط عند النقر على زر "تعليمات هامة".
        });
    </script>

    <!-- شريط الشكر المتحرك - يظهر في كل الشاشات وفي أسفل التقارير عند الطباعة -->
    <div class="thank-you-banner">
        <span>تصميم وبرمجةللمهندس بولس سمير، مدير وحدة تكنولوجيا المعلومات بكلية الطب البيطري جامعة المنيا</span>
    </div>

</body>
</html>
